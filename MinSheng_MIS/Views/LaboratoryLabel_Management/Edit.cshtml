@{
    ViewBag.Title = "編輯實驗標籤";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <style>
        .edit-title {
            font-size: 16px;
            color: #fff;
            margin-top: 12px;
        }
    </style>
}

<h2>@ViewBag.Title</h2>

<section>
    <div class="edit-area edit-area-sm flex-lg-row">
        <form class="form">
            <div class="form-group-zone">
                <div class="form-group required">
                    <label for="EDate">實驗日期</label>
                    <div style="position: relative; overflow: hidden;">
                        <input class="form-control calendar-input" id="EDate" name="EDate" type="text"
                            placeholder="年-月-日" required />
                    </div>
                </div>
                <div class="form-group required">
                    <label for="ExperimentType">實驗類型</label>
                    <select class="form-select" name="ExperimentType" id="ExperimentType" required>
                        <option value="">請選擇</option>
                    </select>
                </div>
                <div class="form-group col-2fr required">
                    <label for="TAWSN">實驗名稱</label>
                    <select class="form-select" name="TAWSN" id="TAWSN" required>
                        <option value="">請選擇</option>
                    </select>
                </div>
            </div>
            <hr class="hr-default">
            <div class="form-group d-flex flex-column align-items-center">
                <h3 class="edit-title w-100">標籤名稱</h3>
                <div class="edit-area flex-wrap w-100" style="gap: 1rem 2rem;">
                    <div class="form-group d-flex flex-column align-items-center w-100 gap-2" id="item-list"></div>
                </div>
                <button type="button" class="addItemBtn" id="create-item"><i class="fa-solid fa-plus"></i></button>
            </div>
        </form>
    </div>
</section>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-submit" id="submit">儲存及列印</button>
</div>

@section scripts {
    <script>
        const ELSN = '@ViewBag.id'
        const apiUrl = '@Url.Action("Read_Data", "LaboratoryLabel_Management")' + `/${ELSN}`;
        //const apiUrl = null;

        const fakeData = {
            ExperimentType: "水質分析",
            ExperimentName: "汙水管水質檢測分析實驗",
            TAWSN: "1",
            EDate: "2023-08-14",
            UploadUserName: "王大明",
            UploadDateTime: "2023/08/13",
            LaboratoryLabelItem: [
                {
                    ELISN: "230814001_001",
                    LabelName: "2023/08/14_5M樣品_1",
                },
                {
                    ELISN: "230814001_002",
                    LabelName: "2023/08/14_5M樣品_2",
                }
            ]
        }

        var labelItems = new LabelItems()
        $(async function () {
            addButtonEvent();
            formDropdown.getSelect('TAWSN').addEventListener("change", function () {
                if (!this.value) return;
                $.getJSON(`@Url.Action("TestingAndAnalysis_LabelName", "TestingAndAnalysisWorkflow")?TAWSN=${this.value}`, (res) => {
                    labelItems.list.children().remove()
                    res.forEach((item) => {
                        labelItems.create(item)
                    })
                })
            })

            readData(apiUrl)
        });

        function save() {
            let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
            console.log("isValidity():", isValidity)
            if (!isValidity) return;
            if (!labelItems.checkValidity()) {
                onError({ responseText: "請至少新增一個實驗標籤名稱！" })
                return;
            }
            var form = new FormData();
            form.append("ELSN", ELSN);
            form.append("TAWSN", document.getElementById("TAWSN").value);
            let EDateValue = dateTransform({ EDate: document.getElementById("EDate").value });
            form.append("EDate", EDateValue.EDate);

            labelItems.calc().forEach((item, i) => {
                form.append(`LabelName[${i}]`, item.LabelName);
            })

            console.log(Object.fromEntries(form.entries()));
            $.ajax({
                url: '@Url.Action("EditLaboratoryLabel", "LaboratoryLabel_Management")',
                data: form,
                type: "POST",
                contentType: false,
                processData: false,
                success: onSuccess,
                error: onError
            })
            function onSuccess(res) {
                console.log(res);
                createDialogModal({
                    id: "DialogModal-Success", inner: "儲存成功！",
                    onHide: () => { window.location.href = "/LaboratoryLabel_Management/Index"; }
                });
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `儲存失敗！` + `${res?.responseText || ""}` })
            }
        }
        function addButtonEvent() {
            $("#back").click(function () {
                history.back();
            })

            $("#submit").click(function () {
                save();
            })
        }

        function LabelItems() {
            this.list = $("#item-list")
            this.count = 0
            const temp_item = (count) => {
                return `<div class="d-flex w-100 gap-3" id="item-${count}">
                                <input id="ELISN" name="ELISN" hidden>
                                <input class="form-control" id="LabelName" name="LabelName" type="text" minlength="1" maxlength="200" required/>
                                <button class="btn-delete-item align-self-center flex-shrink-0" onclick="labelItems.delete(${count})"></button>
                            </div>`
            }
            this.create = (data = null) => {
                if ($("#TAWSN").val() == "") {
                    $("#TAWSN")[0].reportValidity()
                    return;
                }
                let item = $(temp_item(this.count))
                if (data) {
                    item.children("#ELISN").val(data?.ELISN)
                    item.children("#LabelName").val(data.LabelName)
                }
                this.list.append(item)
                this.count++
            }
            this.delete = (count) => {
                $(`#item-${count}`).remove()
            }
            this.calc = () => {
                return this.list.children().toArray().map((e) => {
                    return {
                        ELISN: $(e).children("#ELISN").val(),
                        LabelName: $(e).children("#LabelName").val()
                    }
                })
            }
            this.checkValidity = () => {
                return this.list.children().length > 0
            }
            this.init = () => {
                $("#create-item").click(function () {
                    labelItems.create()
                })
            }
            this.init()
            return this
        }

        function readData(url = null) {

            url == null ? onSuccess(fakeData) :   //fakeData
                $.ajax({
                    url: url,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

            async function onSuccess(res) {
                console.log(res);
                await formDropdown.ExperimentType({ value: res.ExperimentType, tawValue: res.TAWSN })
                $("#EDate").val(dateTransform(res.EDate))

                res.LaboratoryLabelItem.forEach((item) => {
                    labelItems.create(item)
                })
            }
            function onError(res) {
                console.log(res);
            }
        }
    </script>
}