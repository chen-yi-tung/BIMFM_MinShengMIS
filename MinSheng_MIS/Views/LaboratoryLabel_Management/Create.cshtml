@{
    ViewBag.Title = "新增實驗標籤";
}

<style>
    .edit-title {
        font-size: 16px;
        color: #fff;
        margin-top: 12px;
    }
</style>

<h2>@ViewBag.Title</h2>


<section style="max-width: 855px;margin: auto;">
    <div class="edit-area bg-transparent flex-wrap flex-md-row justify-content-lg-center" style="gap: 1rem 2rem;">
        <form class="form d-lg-contents">
            <div class="form-group w-lg-250px required">
                <label for="EDate">實驗日期</label>
                <input class="form-control" id="EDate" name="EDate" type="date" required/>
            </div>

            <div class="form-group w-lg-250px required">
                <label for="ExperimentType">實驗類型</label>
                <select class="form-select" name="ExperimentType" id="ExperimentType" required>
                    <option value="">請選擇</option>
                </select>
            </div>

            <div class="form-group w-lg-532px required">
                <label for="ExperimentName">實驗名稱</label>
                <select class="form-select" name="ExperimentName" id="ExperimentName" required>
                    <option value="">請選擇</option>
                </select>
            </div>
        </form>
    </div>
</section>
<section class="w-lg-532px m-auto">
    <h3 class="edit-title">標籤名稱</h3>
    <div class="edit-area flex-wrap flex-md-row justify-content-lg-center mt-2 p-4" style="gap: 1rem 2rem;">
        <form class="form d-lg-contents p-0" id="item-list"></form>
        <button class="btn btn-create-item w-100" id="create-item">+新增</button>
    </div>
</section>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-submit" id="submit">新增及列印</button>
</div>

<script src="/Scripts/tool.js"></script>
<script src="/Scripts/datatable.js"></script>
<script>

    var labelItems = new LabelItems()
    $(async function () {
        addButtonEvent();
        labelItems.create()
    });

    function save() {
        let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
        console.log("isValidity():", isValidity)
        if (!isValidity) return;

        var form = new FormData();
        form.append("EDate", document.getElementById("EDate").value);
        form.append("ExperimentType", document.getElementById("ExperimentType").value);
        form.append("ExperimentName", document.getElementById("ExperimentName").value);
        
        console.log(Object.fromEntries(form.entries()));
        $.ajax({
            url: '@Url.Action("CreateLaboratoryLabel", "LaboratoryLabel_Management")',
            data: form,
            type: "POST",
            contentType: false,
            processData: false,
            success: onSuccess,
            error: onError
        })
        function onSuccess(res) {
            console.log(res);
            createDialogModal({
                id: "DialogModal-Success", inner: "新增成功！",
                onHide: () => { window.location.href = "/LaboratoryLabel_Management/Management"; }
            });
        }
        function onError(res) {
            console.log(res);
            createDialogModal({ id: "DialogModal-Error", inner: `新增失敗！` + `${res.responseText}` })
        }
    }
    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        })

        $("#submit").click(function () {
            save();
        })
    }

    function LabelItems() {
        this.list = $("#item-list")
        this.count = 0
        const temp_item = (count) => {
            return `<div class="d-flex w-100 gap-3" id="item-${count}">
                <input class="form-control" id="LabelName" name="LabelName" type="text" minlength="1" maxlength="200" required/>
                <button class="btn-delete-item align-self-center" onclick="labelItems.delete(${count})"></button>
            </div>`
        }
        this.create = () => {
            this.list.append(temp_item(this.count))
            this.count++
        }
        this.delete = (count) => {
            $(`#item-${count}`).remove()
        }
        this.calc = () => {
            return this.list.children().toArray().map((e)=>{
                return $(e).children("#LabelName").val()
            })
        }
        this.init = () => {
            $("#create-item").click(function () {
                labelItems.create()
            })
        }
        this.init()
        return this
    }
</script>