@{
    ViewBag.Title = "每日巡檢時程模板 詳情";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <script src="/Scripts/dataTable/InspectionPlanRepair.js" defer></script>
    <script src="/Scripts/dataTable/PlanRecord.js" defer></script>
    <script src="/Scripts/dataTable/EquipmentInfoModal.js" defer></script>
}


<h2>@ViewBag.Title</h2>

<section>
    <div class="info-area">
        <div class="datatable datatable-small">
            <div class="datatable-body">
                <table class="datatable-table" id="PlanDetail"></table>
            </div>
        </div>
        <div class="datatable datatable-grid datatable-md">
            <div class="datatable-body overflow-auto">
                <table class="datatable-table" id="PlanRecord">
                </table>
            </div>
        </div>
    </div>
</section>

@*巡檢路線資訊POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="PlanInfo">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content height-fit">
            <div class="modal-body align-items-center">
                <h2>巡檢路線資訊</h2>
                <div class="datatable datatable-small">
                    <div class="datatable-body">
                        <table class="datatable-table" id="PathDetail"></table>
                    </div>
                </div>
                <div class="datatable datatable-grid datatable-fill">
                    <div class="datatable-body overflow-auto">
                        <table class="datatable-table" id="EInfo">
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-export" data-bs-dismiss="modal">確定</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        let DailyTemplateSN = location.href.split('/').pop();
        let templateApiUrl = null;
        let pathApiUrl = null;

        $(async function () {
            console.log('DailyTemplateSN', DailyTemplateSN);
            updateTemplate(await readData(templateApiUrl, 'sample', DailyTemplateSN))
        })
        let tempData = {};
        //每日巡檢時程模板 詳情
        const SerializedName_Sample = [
            { text: "巡檢模板名稱", value: "TemplateName" },
        ]
        const GridOptions_Sample = {
            thead: true,
            columns: [
                { id: "Index", title: "" },
                { id: "PTime", title: "巡檢時間" },
                { id: "PathName", title: "巡檢路線名稱" },
                { id: "Frequency", title: "巡檢頻率" },
                { id: "PNum", title: "巡檢數量" },
                { id: "Btn", title: "" },
            ]
        }
        let fakeData_Sample = {
            TemplateNameSN: "1120301001",
            TemplateName: "前處理機房巡檢",
            SampleItem: [
                {
                    StartTime: "00:00",
                    EndTime: "01:00",
                    PathName: "前處理機房巡檢",
                    PathNameSN: "2412250001",
                    Frequency: "3",
                    PNum: "10",
                },
                {
                    StartTime: "01:00",
                    EndTime: "02:00",
                    PathName: "前處理機房巡檢",
                    PathNameSN: "2412250002",
                    Frequency: "3",
                    PNum: "10",
                },
                {
                    StartTime: "02:00",
                    EndTime: "03:00",
                    PathName: "生物處理機台巡檢",
                    PathNameSN: "2412250003",
                    Frequency: "3",
                    PNum: "4",
                },
            ]
        }

        //巡檢路線資訊
        const SerializedName_Path = [
            { text: "巡檢路線名稱", value: "PathName" },
            { text: "巡檢時間", value: "PTime" },
        ]
        const GridOptions_Path = {
            thead: true,
            columns: [
                { id: "Index", title: "" },
                { id: "InterCode", title: "RFID內碼" },
                { id: "ExterCode", title: "RFID外碼" },
                { id: "RFIDName", title: "RFID名稱" },
                { id: "Area", title: "RFID棟別" },
                { id: "Floor", title: "RFID樓層" },
                { id: "Memo", title: "RFID備註" },
                { id: "EName", title: "設備名稱" },
                { id: "ESN", title: "設備編號" },
                { id: "Brand", title: "廠牌" },
                { id: "Model", title: "型號" },
                { id: "Frequency", title: "巡檢頻率" },
            ]
        }
        let fakeData_Path = {
            PathNameSN: "1120301001",
            PathName: "前處理機房巡檢",
            StartTime: "00:00",
            EndTime: "01:00",
            EItem: [
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName1",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機1",
                    ESN: "SP-0202A",
                    Brand: "A廠牌",
                    Model: "XMA-56",
                    Frequency: "3",
                },
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName2",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機2",
                    ESN: "SP-0202A",
                    Brand: "B廠牌",
                    Model: "XMA-56",
                    Frequency: "2",
                },
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName3",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機3",
                    ESN: "SP-0202A",
                    Brand: "C廠牌",
                    Model: "XMA-56",
                    Frequency: "2",
                },
            ]
        }
        function updateTemplate(res) {
            $("#PlanDetail").append(createTableInner(res, SerializedName_Sample));
            res.SampleItem ?
                $("#PlanRecord").append(createTableGrid(createIndexToArrayData(res.SampleItem, res.PathNameSN), GridOptions_Sample)) :
                $("#PlanRecord").parents(".datatable").remove();
        }
        async function updatePath(SN) {
            if (!tempData[SN]) {
                console.log('first time store')
                tempData[SN] = await readData(pathApiUrl, 'path', SN);
            }

            $("#PathDetail").empty();
            $("#EInfo").empty();
            $("#PathDetail").append(createTableInner(tempData[SN], SerializedName_Path));
            tempData[SN].EItem ?
                $("#EInfo").append(createTableGrid(createIndexToArrayData(tempData[SN].EItem), GridOptions_Path)) : 
                $("#EInfo").parents(".datatable").remove();
        }
        function readData(url = null, type, SN) {
            let fakeData, apiUrl;
            switch (type) {
                case 'sample':
                    fakeData = fakeData_Sample;
                    apiUrl = `${url}/?DailyTemplateSN=${SN}`
                    break
                case 'path':
                    // 防止淺拷貝
                    fakeData = JSON.parse(JSON.stringify(fakeData_Path));
                    apiUrl = `${url}/?PlanPathSN=${SN}`
                    break
            }
            return new Promise((resolve, reject) => {
                if (url == null) {
                    resolve(onSuccess(fakeData))
                } else {
                    $.ajax({
                        url: apiUrl,
                        type: "GET",
                        dataType: "json",
                        contentType: "application/json;charset=utf-8",
                        success: (res) => {
                            resolve(onSuccess(res));
                        },
                        error: (ex) => {
                            onError(ex);
                            reject(null);
                        }
                    });
                }
            });

            function onSuccess(res) {
                switch (type) {
                    case 'sample':
                        res.SampleItem.forEach(item => {
                            item.PTime = `${item.StartTime}~${item.EndTime}`
                            item.Frequency = `每${item.Frequency}個小時`
                        })
                        break
                    case 'path':
                        res.PTime = `${res.StartTime}~${res.EndTime}`
                        res.EItem.forEach(item => {
                            item.Frequency = `每${item.Frequency}個小時`
                        })
                        break
                }
                console.log("res (after adjusting)", res);
                return res
            }

            function onError(res) {
                console.log(res);
            }

        }

        //在每列加上次序
        function createIndexToArrayData(arr) {
            return arr.map((e, i) => {
                let returnObject = {
                    Index: i + 1,
                    ...e,
                }
                if (e.PathNameSN) returnObject.Btn = `<button type="button" class="btn btn-datagrid" data-bs-toggle="modal" data-bs-target="#PlanInfo" onclick="updatePath('${e.PathNameSN}')">巡檢路線資訊</button>`
                return returnObject
            })
        }

        // 監聽Modal關閉後移除表格
        $('#PlanInfo').on('hide.bs.modal', function () {
            $("#PathDetail").empty();
            $("#EInfo").empty();
        });
    </script>
}