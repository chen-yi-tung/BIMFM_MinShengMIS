@{
    ViewBag.Title = "新增巡檢計畫";
}

@Styles.Render("~/Content/easyui/themes/default/easyui.css")
<script src="/Content/easyui/jquery.min.js"></script>
<script src="/Content/easyui/jquery.easyui.min.js"></script>
<link rel="stylesheet" href="/Content/samplepath.css">
<link rel="stylesheet" href="/Content/tagbox.css">
<link rel="stylesheet" href="/Content/datagrid-modal.css">

<div class="spinner-area">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<h2>@ViewBag.Title</h2>

<section>
    <div class="search-area bg-transparent">
        <form class="form">
            <div class="form-group required">
                <label for="IPName">巡檢計畫名稱</label>
                <input type="text" class="form-control" name="IPName" id="IPName">
            </div>

            <div class="form-group required">
                <label for="PlanDate">巡檢日期</label>
                <input type="date" class="form-control" name="PlanDate" id="PlanDate">
            </div>

            <div class="form-group required">
                <label for="Shift">巡檢班別</label>
                <select type="text" class="form-select" name="Shift" id="Shift" required>
                    <option value="">請選擇</option>
                </select>
            </div>

            <div class="form-group required f-3">
                <label for="UserID">巡檢人員</label>
                <select type="text" class="form-select" name="UserID" id="UserID"></select>
            </div>
        </form>
    </div>

    <div class="sample-path-area">
        <h3 class="sample-path-title">定期保養設備</h3>
        <div class="edit-area" style="gap: 1em;">
            <div class="form-group required d-flex flex-column flex-lg-row align-items-start align-items-lg-center px-4 d-none"
                style="gap:0 1em; width:100%">
                <label for="MaintainUserID" class="flex-shrink-0">審核人員</label>
                <select type="text" class="form-select w-lg-250px" name="MaintainUserID" id="MaintainUserID"
                    style="width: 100%;" required>
                    <option value="">請選擇</option>
                </select>
            </div>
            <div class="datatable-easyui w-100 d-none">
                <table id="Maintain-datagrid"></table>
            </div>
            <div class="edit-button-area m-0 w-auto">
                <button class="btn btn-search" id="Maintain-create" data-bs-toggle="modal"
                    data-bs-target="#DatagridModal-Maintain">新增定期保養設備</button>
                <button class="btn btn-delete d-none" id="Maintain-delete">刪除</button>
            </div>
        </div>
    </div>
    <div class="sample-path-area mt-4">
        <h3 class="sample-path-title">維修設備</h3>
        <div class="edit-area" style="gap: 1em;">
            <div class="form-group required d-flex flex-column flex-lg-row align-items-start align-items-lg-center px-4 d-none"
                style="gap:0 1em; width:100%">
                <label for="RepairUserID" class="flex-shrink-0">審核人員</label>
                <select type="text" class="form-select w-lg-250px" name="RepairUserID" id="RepairUserID"
                    style="width: 100%;" required>
                    <option value="">請選擇</option>
                </select>
            </div>
            <div class="datatable-easyui w-100 d-none">
                <table id="Repair-datagrid"></table>
            </div>
            <div class="edit-button-area m-0 w-auto">
                <button class="btn btn-search" id="Repair-create" data-bs-toggle="modal"
                    data-bs-target="#DatagridModal-Repair">新增維修設備</button>
                <button class="btn btn-delete d-none" id="Repair-delete">刪除</button>
            </div>
        </div>
    </div>
</section>

<div class="modal fade datagrid-modal" tabindex="-1" id="DatagridModal-Maintain">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>新增定期保養單</h2>
                <div class="search-area mb-3">
                    <form class="form">

                        <input class="form-control" id="SourceMaintain" name="SourceMaintain" type="text"
                            value="AddMaintainForm" hidden />

                        <div class="form-group">
                            <label for="ASN">棟別</label>
                            <select class="form-select" name="ASN" id="ASN">
                                <option value="">請選擇</option>
                            </select>
                        </div>
                        <input class="form-control" id="Area" name="Area" type="text" hidden />


                        <div class="form-group">
                            <label for="FSN">樓層</label>
                            <select class="form-select" name="FSN" id="FSN">
                                <option value="">請選擇</option>
                            </select>
                        </div>
                        <input class="form-control" id="Floor" name="Floor" type="text" hidden />

                        <div class="form-group">
                            <label for="ESN">設備編號</label>
                            <input class="form-control" id="ESN" name="ESN" type="text" />
                        </div>

                        <div class="form-group">
                            <label for="EName">設備名稱</label>
                            <input class="form-control" id="EName" name="EName" type="text" />
                        </div>

                        <div class="form-group">
                            <label for="FormItemState">保養狀態</label>
                            <select class="form-select" name="FormItemState" id="FormItemState">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="EState">設備狀態</label>
                            <select class="form-select" name="EState" id="EState">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="StockState">庫存狀態</label>
                            <select class="form-select" name="StockState" id="StockState">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="DateSelect">日期項目選擇</label>
                            <select class="form-select" name="DateSelect" id="DateSelect">
                                <option value="1">上次保養日期</option>
                                <option value="2">最近應保養日期</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="DateFrom">日期(起)</label>
                            <input class="form-control" id="DateFrom" name="DateFrom" type="date" />
                        </div>

                        <div class="form-group">
                            <label for="DateTo">日期(迄)</label>
                            <input class="form-control" id="DateTo" name="DateTo" type="date" />
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-search" id="search">查詢</button>
                            <button type="reset" class="btn btn-clear" id="clear">清除</button>
                        </div>
                    </form>
                </div>
                <table class="modal-datagrid"></table>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="add-row">新增</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade datagrid-modal" tabindex="-1" id="DatagridModal-Repair">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>新增設備維修單</h2>
                <div class="search-area mb-3">
                    <form class="form">

                        <input class="form-control" id="SourceReport" name="SourceReport" type="text"
                            value="AddReportForm" hidden />

                        <div class="form-group">
                            <label for="ASN">棟別</label>
                            <select class="form-select" name="ASN" id="ASN">
                                <option value="">請選擇</option>
                            </select>
                        </div>
                        <input class="form-control" id="Area" name="Area" type="text" hidden />


                        <div class="form-group">
                            <label for="FSN">樓層</label>
                            <select class="form-select" name="FSN" id="FSN">
                                <option value="">請選擇</option>
                            </select>
                        </div>
                        <input class="form-control" id="Floor" name="Floor" type="text" hidden />

                        <div class="form-group">
                            <label for="ReportLevel">報修等級</label>
                            <select class="form-select" name="ReportLevel" id="ReportLevel">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="ESN">設備編號</label>
                            <input class="form-control" id="ESN" name="ESN" type="text" />
                        </div>

                        <div class="form-group">
                            <label for="EName">設備名稱</label>
                            <input class="form-control" id="EName" name="EName" type="text" />
                        </div>

                        <div class="form-group">
                            <label for="ReportState">報修單狀態</label>
                            <select class="form-select" name="ReportState" id="ReportState">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="StockState">庫存狀態</label>
                            <select class="form-select" name="StockState" id="StockState">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="UserID">報修人員</label>
                            <select class="form-select" name="UserID" id="UserID">
                                <option value="">請選擇</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="DateFrom">日期(起)</label>
                            <input class="form-control" id="DateFrom" name="DateFrom" type="date" />
                        </div>

                        <div class="form-group">
                            <label for="DateTo">日期(迄)</label>
                            <input class="form-control" id="DateTo" name="DateTo" type="date" />
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-search" id="search">查詢</button>
                            <button type="reset" class="btn btn-clear" id="clear">清除</button>
                        </div>
                    </form>
                </div>
                <table class="modal-datagrid"></table>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="add-row">新增</button>
            </div>
        </div>
    </div>
</div>

<hr class="hr-dashed">

<section>

    <div class="search-area bg-transparent">
        <div class="form d-flex flex-column flex-xl-row align-items-stretch align-items-xl-end">

            <form class="form-group w-auto w-xl-60" id="sample-path-form">
                <label>選取巡檢路線模板</label>
                <div class="d-flex flex-column flex-lg-row align-items-center" style="gap:1em;">
                    <div class="d-lg-contents d-flex flex-sm-row flex-column w-100" style="gap:1em;">
                        <select type="text" class="form-select w-lg-200px" name="ASN" id="ASN" required>
                            <option value="" disabled selected hidden>區域</option>
                        </select>
                        <select type="text" class="form-select w-lg-100px" name="FSN" id="FSN" required>
                            <option value="" disabled selected hidden>樓層</option>
                        </select>
                    </div>
                    <select type="text" class="form-select w-lg-225px" name="PathTitle" id="PathTitle" required>
                        <option value="" disabled selected hidden>選擇模板</option>
                    </select>
                    <button type="button" class="btn btn-search flex-shrink-0 w-100 w-lg-auto"
                        id="sample-path-create">新增</button>
                </div>
            </form>

            <form class="form-group w-auto w-xl-40" id="path-form">
                <label>新增其他巡檢路線</label>
                <div class="d-flex flex-column flex-lg-row align-items-center" style="gap:1em;">
                    <div class="d-lg-contents d-flex flex-sm-row flex-column w-100" style="gap:1em;">
                        <select type="text" class="form-select w-lg-200px" name="ASN" id="ASN" required>
                            <option value="" disabled selected hidden>區域</option>
                        </select>
                        <select type="text" class="form-select w-lg-100px" name="FSN" id="FSN" required>
                            <option value="" disabled selected hidden>樓層</option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-search flex-shrink-0 w-100 w-lg-auto"
                        id="path-create">新增</button>
                </div>
            </form>

        </div>
    </div>

    <div class="sample-path-area">
        <h3 class="sample-path-title">巡檢路線規劃</h3>

        <div class="edit-area">
            <div class="sample-path-group-area"></div>

            <div class="sample-path-draw-area d-none">
                <div class="mb-4">
                    <div class="path-title-edit-group">
                        <input type="text" id="PathID" hidden>
                        <label for="current-PathTitle">路線名稱</label>
                        <input class="form-control" type="text" id="current-PathTitle" name="current-PathTitle">
                        <button class="btn btn-cancel" id="pathtitle-save">儲存模板</button>
                    </div>
                    <div class="input-group sample-path-group inner">
                        <div type="text" class="form-control">
                            <nav>
                                <ol class="breadcrumb" id="current-path-display"></ol>
                            </nav>
                            <button class="path-btn align-self-center" id="current-path-edit" data-bs-toggle="tooltip"
                                title="手動修改路線">
                                <i class="icon-edit"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="sample-path-toolbar">
                    <button class="path-icon path-icon-radio" id="path-draw" data-bs-toggle="tooltip"
                        data-bs-placement="right" title="規劃路線">
                        <i class="icon-pen"></i>
                    </button>
                    <button class="path-icon path-icon-radio" id="path-eraser" data-bs-toggle="tooltip"
                        data-bs-placement="right" title="清除路線">
                        <i class="icon-eraser"></i>
                    </button>

                    <hr class="m-0">

                    <button class="path-icon" id="path-reload" data-bs-toggle="tooltip" data-bs-placement="right"
                        title="重新規劃路線">
                        <i class="icon-reload"></i>
                    </button>
                    <button class="path-icon" id="path-auto" data-bs-toggle="tooltip" data-bs-placement="right"
                        title="自動計算路線">
                        <i class="icon-auto"></i>
                    </button>
                </div>
                <div class="viewer3Dcontainer">
                    <div id="viewer3d" style="margin:0;"></div>
                    <canvas id="PathCanvas"></canvas>
                </div>

                <div class="label-area">
                    <div class="label-item">
                        <div class="cube cube-bluetooth"></div>
                        <span>藍芽</span>
                    </div>
                    <div class="label-item">
                        <div class="cube cube-maintain"></div>
                        <span>定期保養</span>
                    </div>
                    <div class="label-item">
                        <div class="cube cube-repair"></div>
                        <span>維修</span>
                    </div>
                    <div class="label-item">
                        <div class="cube cube-both"></div>
                        <span>維修+保養</span>
                    </div>
                </div>
                <div class="button-area mt-3">
                    <button class="btn btn-search" id="path-save">儲存變更</button>
                </div>
            </div>
        </div>
    </div>

</section>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">新增計畫</button>
</div>

<!-- Autodesk Forge -->
<link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/style.min.css?v=v7.4"
    type="text/css">
<script language="JavaScript"
    src="https://developer.api.autodesk.com/modelderivative/v2/viewers/viewer3D.min.js?v=v7.4"></script>
<script language="JavaScript" src="/Scripts/Forge/UpViewer.js"></script>

<!-- PIXI Draw -->
<script src="https://pixijs.download/v7.2.2/pixi.js"></script>
<script src="/Scripts/ForgeDraw.js"></script>
<script src="/Scripts/datatable.js"></script>
<script>
    var view = document.querySelector("#PathCanvas");
    var app;
    var stage;
    let btUrl = "/Content/img/bluetooth.svg";

    function initializeDrawer() {
        app = ForgeDraw.init(view, viewer, function () {
            view.addEventListener("fd.linedata.change", function (event) {
                console.log("view => fd.linedata.change");
                calcRoute();
            });
            view.addEventListener("fd.linedata.detail", function (event) {
                console.log("view => fd.linedata.detail", event.detail);
                if (event.detail instanceof ForgeDraw.DevicePoint) {
                    let url = `@Url.Action("ReadBody", "EquipmentInfo_Management")/${event.detail.dbId}`
                    $.getJSON(url, function (res) {
                        createDataDetailModal({
                            title: "設備資訊",
                            id: "",
                            sn: [
                                { text: "系統別", value: "System" },
                                { text: "子系統別", value: "SubSystem" },
                                { text: "設備名稱", value: "EName" },
                                { text: "區域", value: "Area" },
                                { text: "樓層", value: "Floor" },
                                { text: "空間名稱", value: "RoomName" },
                                { text: "國有財產編碼", value: "PropertyCode" },
                                { text: "廠牌", value: "Brand" },
                                { text: "DBID", value: "DBID" },
                                { text: "RFID", value: "RFID" },
                                { text: "設備狀態", value: "EState" },
                                { text: "座標X", value: "x" },
                                { text: "座標Y", value: "y" },
                            ],
                            data: Object.assign({
                                x: event.detail.forgePos.x,
                                y: event.detail.forgePos.y
                            }, res)
                        });
                    })
                }
                else {
                    createDataDetailModal({
                        title: "座標資訊",
                        id: "",
                        sn: [
                            { text: "座標X", value: "x" },
                            { text: "座標Y", value: "y" },
                        ],
                        data: { x: event.detail.forgePos.x, y: event.detail.forgePos.y }
                    });
                }
            });
            view.addEventListener("fd.linedata.removeall", function (event) {
                console.log("view => fd.linedata.removeall");
                updatePathDisplay();
            });
            view.addEventListener("fd.devicepoint.ignore", function (event) {
                console.log("view => fd.devicepoint.ignore");
                calcRoute();
            });

            readBeaconData(fakeData.PathSample.Beacon);
            readDeviceData(1);
            readPathData(fakeData.PathSampleRecord);
            updatePathDisplay(fakeData.PathSampleOrder);

            calcRoute();

            addTooltip();
            togglePointerEvent(true);
        });

        window.addEventListener('resize', function () {
            ForgeDraw.resize();
        })

    }

    function calcRoute() {

        if (ForgeDraw.lineData.length > 1) {
            ForgeDraw.devices.forEach((dp) => {
                dp.update();
            })
        }

        if (!sortRouteModal.autoCalcRoute) {
            return;
        }

        //開始計算路徑
        let route = ForgeDraw.getRoute().map(e => e.name);
        console.log(ForgeDraw.devices.map(e => e.result));

        //route.unshift("起點");
        //route.push("終點");

        //顯示在網頁上
        updatePathDisplay(route);
    }

    //更新網頁顯示的路徑
    function updatePathDisplay(path = undefined) {
        let Cpath = $("#current-path-display");
        let pathID = $("#PathID").val();
        let $path = $(`.sample-path-group[data-path-id=${pathID}]`).find("#path-display");

        if (!path) {
            $path.empty();
            Cpath.empty();
            /*$path.append(`
            <li class="breadcrumb-item">起點</li>
            <li class="breadcrumb-item">終點</li>
            `);*/
            return;
        }

        $path.empty();
        Cpath.empty();
        path.forEach(r => {
            let pathPoint = `<li class="breadcrumb-item">${r}</li>`;
            $path.append(pathPoint);
            Cpath.append(pathPoint);
        })
    }

    //切換操作
    function controlToggle(id, control) {
        let btn = $("#" + id);
        ForgeDraw.setControl(control);

        $(".path-icon-radio").removeClass("active");
        btn.toggleClass("active", true);
    }

    //更換模型和設備
    function loadModel(pathID) {
        ForgeDraw.removeAllDevice();
        ForgeDraw.removeAllData();
        ForgeDraw.clearSelectPos();

        viewer.loadModel(
            viewerUrl,
            { keepCurrentModels: false },
            onSuccess,
            onError
        );

        function onSuccess(res) {
            $(viewer).one(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, function () {
                $(viewer).one(Autodesk.Viewing.FINAL_FRAME_RENDERED_CHANGED_EVENT, function () {
                    readBeaconData(fakeData.PathSample.Beacon);
                    readDeviceData(pathID);
                    readPathData(fakeData.PathSampleRecord);
                    updatePathDisplay(fakeData.PathSampleOrder);

                    calcRoute();

                    addTooltip();
                    togglePointerEvent(true);
                })
            })
        }
        function onError(err) {
            console.log(err);
        }
    }

    //讀取藍芽資料並繪製
    function readBeaconData(data) {
        data.forEach((e) => {
            let btSprite = PIXI.Sprite.from(btUrl);
            btSprite.scale.set(0.6);
            btSprite.anchor.set(0.5);
            let dp = new ForgeDraw.DevicePoint(e, { sprite: btSprite });
        });
    }

    //讀取設備資料並繪製
    function readDeviceData(pathID) {
        console.time("readDeviceData")
        let deviceDatas = JSON.parse(sessionStorage.getItem(`DeviceDatas`));
        let pathData = JSON.parse(sessionStorage.getItem(`P${pathID}_pathData`));

        let ASN = pathData.PathSample.ASN;
        let FSN = pathData.PathSample.FSN;

        let dataM = getESN("Maintain-datagrid");
        let dataR = getESN("Repair-datagrid");
        let BothDevice = dataM.filter(x => dataR.includes(x));
        let MaintainE = dataM.filter(x => !dataR.includes(x));
        let RepairE = dataR.filter(x => !dataM.includes(x));

        pathData.MaintainEquipment = MaintainE;
        pathData.RepairEquipment = RepairE;
        pathData.BothEquipment = BothDevice;

        console.log("readDeviceData", pathData);
        sessionStorage.setItem(`P${pathID}_pathData`, JSON.stringify(pathData));

        BothDevice.forEach(ESN => {
            let e = deviceDatas[ASN][FSN][ESN];
            e.deviceType = "BothDevice";
            new ForgeDraw.DevicePoint(e, { color: ForgeDraw.Colors.BothDevice });
        })
        MaintainE.forEach(ESN => {
            let e = deviceDatas[ASN][FSN][ESN];
            e.deviceType = "Maintain";
            new ForgeDraw.DevicePoint(e, { color: ForgeDraw.Colors.Maintain });
        })
        RepairE.forEach(ESN => {
            let e = deviceDatas[ASN][FSN][ESN];
            e.deviceType = "Repair";
            new ForgeDraw.DevicePoint(e, { color: ForgeDraw.Colors.Repair });
        })

        console.timeEnd("readDeviceData")

        function getESN(id) {
            if ($("#" + id).css("display") !== 'none') { return []; }

            let data = $("#" + id).datagrid("getRows");
            if (data.length === 0) { return []; }

            let Area = pathData.PathSample.Area;
            let Floor = pathData.PathSample.Floor;

            return data.filter((e, i, arr) => {
                return e.Area == Area && e.Floor == Floor;
            }).map((e) => e.ESN).filter((e, i, arr) => arr.indexOf(e) === i);
        }

    }

    //讀取路線資料
    function readPathData(data) {
        let reslineData = data.map((d) => {
            let forgePos = new THREE.Vector3(d.LocationX, d.LocationY, 0);
            let pos = viewer.worldToClient(forgePos);
            let position = new PIXI.Point(pos.x, pos.y);
            return {
                position: position,
                forgePos: forgePos
            };
        });
        ForgeDraw.readLineData(reslineData);
    }
</script>

<!-- Drag and Drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="/Scripts/Forge/SortRouteModal.js"></script>
<script>
    const sortRouteModal = new SortRouteModal({
        onSave: updatePathDisplay
    });
</script>

<!-- EVENT -->
<script src="/Scripts/tool.js"></script>
<script>
    let fakeData;

    let DatagridEvent;

    $(async function () {
        addButtonEvent();
        addForgeDrawEvent();
        DatagridEvent = addDatagridEvent();
        await addDropDownList();
        await addAreaFloorEvent();
        controlToggle("path-draw", ForgeDraw.Control.DRAW);
        sortRouteModal.autoRouteToggle(true);

        await $('#UserID').tagbox({
            url: '@Url.Action("AllMyName", "DropDownList")',
            textField: 'Text',
            valueField: 'Value',
            hasDownArrow: true,
            limitToList: true,
        });

        $(".spinner-area").fadeOut(300, function () { $(this).remove(); });

        window.addEventListener("beforeunload", (event) => {
            sessionStorage.clear();
        });
    });

    async function addDropDownList() {
        await pushSelect("Shift", '@Url.Action("Shift", "DropDownList")');
        await pushSelect("MaintainUserID", '@Url.Action("AllMyName", "DropDownList")');
        await pushSelect("RepairUserID", '@Url.Action("AllMyName", "DropDownList")');


        let DMM = 'DatagridModal-Maintain';
        await pushSelect(DMM + " #FormItemState", '@Url.Action("AddFormItemState", "DropDownList")');
        await pushSelect(DMM + " #EState", '@Url.Action("EState", "DropDownList")' + "?url=AddToPlan");
        await pushSelect(DMM + " #StockState", '@Url.Action("StockState", "DropDownList")');

        let DMR = 'DatagridModal-Repair';
        pushSelect(DMR + " #ReportLevel", '@Url.Action("ReportLevel", "DropDownList")');
        pushSelect(DMR + " #ReportState", '@Url.Action("Report_Management_Management_ReportFormState", "DropDownList")?url=CanAddToPlanReportState');
        pushSelect(DMR + " #UserID", '@Url.Action("ReportUser", "DropDownList")');
        pushSelect(DMR + " #StockState", '@Url.Action("StockState", "DropDownList")');
    }

    async function addAreaFloorEvent() {
        let areaList = ["path-form", "sample-path-form", "DatagridModal-Maintain", "DatagridModal-Repair"];
        areaList.forEach((id) => {
            pushSelect(`${id} #ASN`, '@Url.Action("Area", "DropDownList")');
            let ASN = $(`#${id} #ASN`);

            ASN.on("change", async function () {

                if (ASN.val()) {
                    $(`#${id} #Area`).val(ASN.children("option:selected").text());
                }
                else {
                    $(`#${id} #Area`).val('');
                }

                await pushSelect(`${id} #FSN`, '@Url.Action("Floor", "DropDownList")' + `?ASN=${ASN.val()}`);
                $(`#${id} #FSN`).val('');
            });
        })

        let floorList = ["path-form", "sample-path-form", "DatagridModal-Maintain", "DatagridModal-Repair"];
        floorList.forEach((id) => {
            let FSN = $(`#${id} #FSN`);

            FSN.on("change", async function () {

                if (FSN.val()) {
                    $(`#${id} #Floor`).val(FSN.children("option:selected").text());
                }
                else {
                    $(`#${id} #Floor`).val('');
                }

                if (id == "sample-path-form") {
                    await pushSelect(`${id} #PathTitle`, '@Url.Action("PathTitle", "DropDownList")' + `?FSN=${FSN.val()}`);
                    $(`#${id} #PathTitle`).val('');
                }
            });
        })
    }

    function addForgeDrawEvent() {
        /* 畫線功能 */
        $("#path-edit").click(function () {
            sortRouteModal.create();
        })
        $("#path-draw").click(function () {
            $(this).blur();
            controlToggle("path-draw", ForgeDraw.Control.DRAW);
        })
        $("#path-eraser").click(function () {
            $(this).blur();
            controlToggle("path-eraser", ForgeDraw.Control.ERASER);
        })
        $("#path-reload").click(function () {
            $(this).blur();
            ForgeDraw.removeAllData();
            sortRouteModal.autoRouteToggle(true);
        })
        $("#path-auto").click(function () {
            $(this).blur();
            sortRouteModal.autoRouteToggle();
            calcRoute();
        })
    }

    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        })
        $("#path-create").click(function (e) {
            e.preventDefault();
            console.log("onclick path-create");
            pathCreateEvent("path-form")
        })
        $("#sample-path-create").click(function (e) {
            e.preventDefault();
            console.log("onclick sample-path-create");
            pathCreateEvent("sample-path-form")
        })
        $("#path-save").click(function () {
            savePath()
            createDialogModal({ id: "DialogModal", inner: "儲存成功！" })
        })
        $("#current-PathTitle").change(function () {
            let pathID = $("#PathID").val()
            let pathData = JSON.parse(sessionStorage.getItem(`P${pathID}_pathData`))
            let title = $("#current-PathTitle").val()
            pathData.PathSample.PathTitle = title
            sessionStorage.setItem(`P${pathID}_pathData`, JSON.stringify(pathData))

            //修改上方路線名稱
            $(`[data-path-id=${pathID}] #sample-path-name`).text(title)
        })
        $("#current-path-edit").click(function () {
            sortRouteModal.create("#current-path-display");
        })
        $("#submit").click(function () {
            console.log("onclick submit")
            save();
        })
        function pathCreateEvent(id) {
            if ($("#PlanDate").val() == '') {
                createDialogModal({
                    id: "DialogModal",
                    inner: `請輸入計畫日期！`
                })
                return;
            }
            let form = $("#" + id);
            if (form[0].checkValidity()) {

                let inputData = getDataGridData(form);
                $(".sample-path-draw-area").removeClass("d-none");

                $.ajax({
                    url: '@Url.Action("AddPlanPath", "InspectionPlan_Management")',
                    data: JSON.stringify(inputData),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

                function onSuccess(res) {
                    console.log(res);
                    fakeData = res;
                    togglePointerEvent(false);
                    //若非第一次初始化
                    let pathID = addRouteGroup(res);
                    $("#PathID").val(pathID);

                    sessionStorage.setItem(`P${pathID}_pathData`, JSON.stringify(res));

                    viewerUrl = "../" + res.PathSample.BIMPath;
                    if (viewer) {
                        loadModel(pathID);
                    }
                    else {
                        initializeViewer(initializeDrawer);
                    }
                }

                function onError(err) {
                    console.log(err);
                }

            }

            function getDataGridData(form) {
                let Area = form.find("#ASN option:selected").text();
                let Floor = form.find("#FSN option:selected").text();

                let data = {
                    ASN: form.find("#ASN").val(),
                    FSN: form.find("#FSN").val(),
                    PathTitle: form.find("#PathTitle").val() ?? '',
                    PlanDate: $("#PlanDate").val(),
                };
                console.log("getDataGridData: ", data);
                return data;
            }
        }

        let path_id = 1;
        function addRouteGroup(data) {
            let path = data.PathSampleOrder ?
                data.PathSampleOrder.map((e) => `<li class="breadcrumb-item">${e}</li>`).join('') : '';
            let PathTitle = data.PathSample ? data.PathSample.PathTitle : '';
            let group = $(`
            <div class="input-group sample-path-group" data-path-id="${path_id}">
                <div class="input-group-text">
                    <button class="path-btn me-2" id="path-handle" data-bs-toggle="tooltip" title="拖曳順序">
                        <i class="icon-handle"></i>
                    </button>
                    <span id="sample-path-name">${PathTitle}</span>
                </div>
                <div type="text" class="form-control">
                    <nav>
                        <ol class="breadcrumb" id="path-display">
                            ${path}
                        </ol>
                    </nav>
                    <button class="path-btn" id="path-edit" data-bs-toggle="tooltip" title="查看此路線">
                        <i class="icon-search"></i>
                    </button>
                </div>
                <button class="btn-delete-item" data-bs-toggle="tooltip" title="刪除路線"></button>
            </div>`);

            $("#current-PathTitle").val(PathTitle);

            $(".sample-path-group-area").append(group);

            group.find(".btn-delete-item").click(function () {
                let dm = createDialogModal({
                    id: "DialogModal", inner: `確定刪除此路線？`,
                    button: [
                        {
                            className: "btn btn-cancel",
                            cancel: true,
                            text: "取消",
                        },
                        {
                            className: "btn btn-delete",
                            text: "確定",
                            onClick: function () {
                                let id = group.attr('data-path-id');
                                sessionStorage.removeItem(`P${id}_pathData`);
                                group.remove();
                                $(".sample-path-draw-area").addClass('d-none');
                                dm.hide();
                            }
                        },
                    ]
                })
            })

            group.find("#path-edit").click(() => {
                let id = group.attr("data-path-id");
                if (!$(".sample-path-draw-area").hasClass('d-none')) {
                    savePath()
                }

                loadPath(id)
            })

            path_id++;

            new Sortable(document.querySelector(".sample-path-group-area"), {
                handle: "#path-handle",
                animation: 150,
            })

            return group.attr('data-path-id');
        }
    }

    function addDatagridEvent() {
        const M_MDG = $('#DatagridModal-Maintain .modal-datagrid');
        const E_MDG = $('#Maintain-datagrid');

        const M_RDG = $('#DatagridModal-Repair .modal-datagrid');
        const E_RDG = $('#Repair-datagrid');

        let M_MSC = null;

        let M_RSC = null;

        const options = {
            //rownumbers: true,
            remoteSort: false,
            sortOrder: 'asc',
            singleSelect: false,
            selectOnCheck: true,
            checkOnSelect: true
        };

        const pageOptions = {
            pageSize: 10,
            showPageList: true,
            pageList: [10, 20, 50],
            beforePageText: '第',
            afterPageText: '頁，共 {pages} 頁',
            displayMsg: '顯示 {from} 到 {to} 筆資料，共 {total} 筆資料'
        };

        const MaintainColumns = {
            idField: 'EMFISN',
            //sortName: 'EMFISN',
            columns: [[
                { field: 'FormItemStatenum', hidden: true },
                { field: 'StockState', title: '庫存狀態', align: 'center', width: 120, sortable: true },
                { field: 'FormItemState', title: '保養項目狀態', align: 'center', width: 150, sortable: true },
                { field: 'EState', title: '設備狀態', align: 'center', width: 120, sortable: true },
                { field: 'Area', title: '棟別', align: 'center', width: 130, sortable: true },
                { field: 'Floor', title: '樓層', align: 'center', width: 80, sortable: true },

                { field: 'ESN', title: '設備編號', align: 'center', width: 100, sortable: true },
                { field: 'EName', title: '設備名稱', align: 'center', width: 220, sortable: true },

                { field: 'EMFISN', title: '保養單項目編號', align: 'center', width: 225, sortable: true },

                { field: 'MIName', title: '保養項目', align: 'center', width: 200, sortable: true },
                { field: 'Period', title: '週期', align: 'center', width: 100, sortable: true },
                { field: 'Unit', title: '週期單位', align: 'center', width: 130, sortable: true },

                { field: 'LastTime', title: '上次保養', align: 'center', width: 150, sortable: true },
                { field: 'Date', title: '最近應保養', align: 'center', width: 150, sortable: true },
            ]]
        };

        this.mdg = {
            onDetail: function (index) {
                M_MSC = getChecked(M_MDG, index);
                let row = M_MDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","MaintainForm_Management")/' + `${row.EMFISN}`;
                window.open(url, "_blank");
            },
            onLocate: function (index) {
                M_MSC = getChecked(M_MDG, index);
                let row = M_MDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","MaintainForm_Management")/' + `${row.EMFISN}`;
                window.open(url, "_blank");
            }
        }

        this.emdg = {
            onDetail: function (index) {
                M_MSC = getChecked(E_MDG, index);
                let row = E_MDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","MaintainForm_Management")/' + `${row.EMFISN}`;
                window.open(url, "_blank");
            },
            onLocate: function (index) {
                M_MSC = getChecked(E_MDG, index);
                let row = E_MDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","MaintainForm_Management")/' + `${row.EMFISN}`;
                window.open(url, "_blank");
            }
        }

        const RepairColumns = {
            idField: 'RSN',
            //sortName: 'RSN',
            columns: [[
                { field: 'ReportStatenum', hidden: true },
                { field: 'StockState', title: '庫存狀態', align: 'center', width: 120, sortable: true },
                { field: 'ReportState', title: '報修單狀態', align: 'center', width: 145, sortable: true },
                { field: 'EState', title: '設備狀態', align: 'center', width: 120, sortable: true },
                { field: 'Area', title: '棟別', align: 'center', width: 130, sortable: true },
                { field: 'Floor', title: '樓層', align: 'center', width: 80, sortable: true },

                { field: 'ESN', title: '設備編號', align: 'center', width: 100, sortable: true },
                { field: 'EName', title: '設備名稱', align: 'center', width: 220, sortable: true },

                { field: 'RSN', title: '報修單號', align: 'center', width: 116, sortable: true },
                { field: 'ReportLevel', title: '報修等級', align: 'center', width: 95, sortable: true },
                { field: 'Date', title: '報修時間', align: 'center', width: 200, sortable: true },
                { field: 'MyName', title: '報修人員', align: 'center', width: 110, sortable: true },
                { field: 'ReportContent', title: '報修內容', align: 'center', width: 300, sortable: true },
            ]]
        }

        this.rdg = {
            onDetail: function (index) {
                M_RSC = getChecked(M_RDG, index);
                let row = M_RDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","Report_Management")/' + `${row.RSN}`;
                window.open(url, "_blank");
            },
            onLocate: function (index) {
                M_RSC = getChecked(M_RDG, index);
                let row = M_RDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","Report_Management")/' + `${row.RSN}`;
                window.open(url, "_blank");
            }
        }

        this.erdg = {
            onDetail: function (index) {
                M_RSC = getChecked(E_RDG, index);
                let row = E_RDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","Report_Management")/' + `${row.RSN}`;
                window.open(url, "_blank");
            },
            onLocate: function (index) {
                M_RSC = getChecked(E_RDG, index);
                let row = E_RDG.datagrid('getRows')[index];
                let url = '@Url.Action("Read","Report_Management")/' + `${row.RSN}`;
                window.open(url, "_blank");
            }
        }


        $("#Maintain-create").one("click", MaintainCreate)

        $("#Repair-create").one("click", RepairCreate)

        function MaintainCreate() {
            let id = "DatagridModal-Maintain";
            let modal = $("#" + id);
            modal.one("shown.bs.modal", () => {
                initDatagrid();
                modal.on("shown.bs.modal", () => { M_MDG.datagrid("load") });
                modal.on("hidden.bs.modal", () => { $(`#${id} form`)[0].reset(); M_MDG.datagrid("clearChecked"); });
            });

            $(`#${id} #search`).click(() => { loadDatagrid(id) });

            $(`#${id} #add-row`).on("click", addRowEvent);

            function initDatagrid() {
                const dg = M_MDG;
                dg.datagrid(
                    Object.assign(
                        {
                            url: '@Url.Action("MaintainForm_Management", "MaintainForm_Management")',
                            method: 'POST',
                            queryParams: getQueryParams(`#${id} form`),
                            fit: true,
                            pagination: true,
                            pagePosition: 'bottom',
                            pageSize: 10,
                            frozenColumns: [[
                                { field: '_select', checkbox: true, },
                                {
                                    field: '_detail', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.mdg.onDetail(${index})">詳情</button>`;
                                    }
                                },
                                {
                                    field: '_locate', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.mdg.onLocate(${index})">定位</button>`;
                                    }
                                }
                            ]],
                            onBeforeSelect: (index) => onBeforeSelect(dg, index, M_MSC, false),
                            onBeforeUnselect: (index) => onBeforeSelect(dg, index, M_MSC, true),
                            onLoadSuccess: (data) => {
                                data.rows.forEach((row, index, arr) => {
                                    switch (row.FormItemStatenum) {
                                        case '9':
                                        case '10':
                                        case '11':
                                            dg.datagrid('getPanel').find('.datagrid-row [field="_select"]')[index].innerHTML = ""
                                            break;
                                    }
                                })
                                dg.datagrid('getPanel').find('.datagrid-header-check')[0].innerHTML = ""
                            }
                        },
                        options,
                        MaintainColumns
                    )
                )
                $(dg.datagrid('getPager')).pagination(pageOptions);
            }
            function initResultDatagrid() {
                const dg = E_MDG;
                dg.datagrid(
                    Object.assign(
                        {
                            frozenColumns: [[
                                { field: '_select', checkbox: true, },
                                {
                                    field: '_detail', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.emdg.onDetail(${index})">詳情</button>`;
                                    }
                                },
                                {
                                    field: '_locate', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.emdg.onLocate(${index})">定位</button>`;
                                    }
                                }
                            ]],
                            onBeforeSelect: (index) => onSelectBtn(dg, index, M_MSC),
                            onBeforeUnselect: (index) => onSelectBtn(dg, index, M_MSC),
                        },
                        options,
                        MaintainColumns
                    )
                )
                window.addEventListener("resize", (event) => {
                    dg.datagrid('resize');
                });
            }
            function addRowEvent() {
                if (M_MDG.datagrid("getChecked").length !== 0) {
                    $(`#${id} #add-row`).off("click", addRowEvent);

                    $(`#${id} #add-row`).on("click", function () {
                        if (M_MDG.datagrid("getChecked").length !== 0) {
                            changeEditAreaCss.call($("#Maintain-create")[0]);
                            appendData.call(this);
                        }
                    });
                    $("#Maintain-delete").on("click", function () {
                        if (E_MDG.datagrid("getChecked").length !== 0) {
                            removeData.call(this);
                        }
                    });

                    changeEditAreaCss.call($("#Maintain-create")[0]);
                    initResultDatagrid();
                    $(`#${id} #add-row`).click();
                }
            }
            function appendData() {
                let data = M_MDG.datagrid("getChecked");
                console.log("appendData POST", data);
                let btn = $(this);
                btn.append(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`);

                getDeviceData(data);

                $.ajax({
                    url: '@Url.Action("AddMaintainForm", "InspectionPlan_Management")',
                    data: JSON.stringify(data.map(d => d.EMFISN)),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

                function onSuccess(res) {
                    console.log("appendData onSuccess", res)
                    btn.children(".spinner-border").remove();
                    bootstrap.Modal.getInstance(modal[0]).hide();

                    res.rows.forEach((d) => { E_MDG.datagrid("appendRow", d) })

                    reloadDeviceData();
                }
                function onError(err) {
                    btn.children(".spinner-border").remove();
                    createDialogModal({
                        id: "DialogModal-Error",
                        inner: "新增失敗！",
                        button: [{ className: "btn btn-delete", cancel: true, text: "確定" }]
                    })
                }
            }
            function removeData() {
                let data = E_MDG.datagrid("getChecked").map((d) => { return d.EMFISN });
                console.log(data);
                let btn = $(this);
                btn.append(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`);

                $.ajax({
                    url: '@Url.Action("DeleteMaintainForm", "InspectionPlan_Management")',
                    data: JSON.stringify(data),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

                function onSuccess(res) {
                    console.log(res);
                    btn.children(".spinner-border").remove();
                    bootstrap.Modal.getInstance(modal[0]).hide();

                    createDialogModal({
                        id: "DialogModal-Success",
                        inner: "刪除成功！",
                    })

                    res.forEach((d) => { E_MDG.datagrid("deleteRow", E_MDG.datagrid("getRowIndex", d.EMFISN)) })

                    reloadDeviceData();

                    E_MDG.datagrid("clearChecked");

                    if (E_MDG.datagrid("getRows").length === 0) {
                        changeEditAreaCss.call($("#Maintain-create")[0], true)
                    }
                }
                function onError(err) {
                    btn.children(".spinner-border").remove();
                    createDialogModal({
                        id: "DialogModal-Error",
                        inner: "刪除失敗！",
                    })
                    E_MDG.datagrid("clearChecked");
                }
            }
        }
        function RepairCreate() {
            let id = "DatagridModal-Repair";
            let modal = $("#" + id);
            modal.one("shown.bs.modal", () => {
                initDatagrid();
                modal.on("shown.bs.modal", () => { M_RDG.datagrid("load") });
                modal.on("hidden.bs.modal", () => { $(`#${id} form`)[0].reset(); M_RDG.datagrid("clearChecked"); });
            });
            $(`#${id} #search`).click(() => { loadDatagrid(id) });

            $(`#${id} #add-row`).on("click", addRowEvent);

            function initDatagrid() {
                const dg = M_RDG;
                dg.datagrid(
                    Object.assign(
                        {
                            url: '@Url.Action("Report_Management", "Datagrid")',
                            method: 'POST',
                            queryParams: getQueryParams(`#${id} form`),
                            fit: true,
                            pagination: true,
                            pagePosition: 'bottom',
                            pageSize: 10,
                            frozenColumns: [[
                                { field: '_select', checkbox: true },
                                {
                                    field: '_detail', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.rdg.onDetail(${index})">詳情</button>`;
                                    }
                                },
                                {
                                    field: '_locate', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.rdg.onLocate(${index})">定位</button>`;
                                    }
                                }
                            ]],
                            onBeforeSelect: (index) => onBeforeSelect(dg, index, M_RSC, false),
                            onBeforeUnselect: (index) => onBeforeSelect(dg, index, M_RSC, true),
                            onLoadSuccess: (data) => {
                                data.rows.forEach((row, index, arr) => {
                                    switch (row.ReportStatenum) {
                                        case '9':
                                        case '10':
                                        case '11':
                                            dg.datagrid('getPanel').find('.datagrid-row [field="_select"]')[index].innerHTML = ""
                                            break;
                                    }
                                })
                                dg.datagrid('getPanel').find('.datagrid-header-check')[0].innerHTML = ""
                            }
                        },
                        options,
                        RepairColumns
                    )
                )
                $(dg.datagrid('getPager')).pagination(pageOptions);
            }
            function initResultDatagrid() {
                const dg = E_RDG;
                dg.datagrid(
                    Object.assign(
                        {
                            frozenColumns: [[
                                { field: '_select', checkbox: true },
                                {
                                    field: '_detail', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.erdg.onDetail(${index})">詳情</button>`;
                                    }
                                },
                                {
                                    field: '_locate', align: 'center', width: 71,
                                    formatter: (val, row, index) => {
                                        return `<button class="btn btn-datagrid" onclick="DatagridEvent.erdg.onLocate(${index})">定位</button>`;
                                    }
                                }
                            ]],
                            onBeforeSelect: (index) => onSelectBtn(dg, index, M_RSC),
                            onBeforeUnselect: (index) => onSelectBtn(dg, index, M_RSC),
                        },
                        options,
                        RepairColumns
                    )
                )
                window.addEventListener("resize", (event) => {
                    dg.datagrid('resize');
                });
            }
            function addRowEvent() {
                if (M_RDG.datagrid("getChecked").length !== 0) {
                    $(`#${id} #add-row`).off("click", addRowEvent);

                    $(`#${id} #add-row`).on("click", function () {
                        if (M_RDG.datagrid("getChecked").length !== 0) {
                            changeEditAreaCss.call($("#Repair-create")[0]);
                            appendData.call(this);
                        }
                    });
                    $("#Repair-delete").on("click", function () {
                        if (E_RDG.datagrid("getChecked").length !== 0) {
                            removeData.call(this);
                        }
                    });

                    changeEditAreaCss.call($("#Repair-create")[0]);
                    initResultDatagrid();
                    $(`#${id} #add-row`).click();
                }
            }
            function appendData() {
                let data = M_RDG.datagrid("getChecked");
                console.log("appendData POST", data);
                let btn = $(this);
                btn.append(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`);

                getDeviceData(data);

                $.ajax({
                    url: '@Url.Action("AddReportForm", "InspectionPlan_Management")',
                    data: JSON.stringify(data.map(d => d.RSN)),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

                function onSuccess(res) {
                    console.log("appendData onSuccess", res)
                    btn.children(".spinner-border").remove();
                    bootstrap.Modal.getInstance(modal[0]).hide();

                    res.rows.forEach((d) => { E_RDG.datagrid("appendRow", d) })

                    reloadDeviceData();
                }
                function onError(err) {
                    btn.children(".spinner-border").remove();
                    createDialogModal({
                        id: "DialogModal-Error",
                        inner: "新增失敗！",
                    })
                }
            }
            function removeData() {
                let data = E_RDG.datagrid("getChecked").map((d) => { return d.RSN });
                console.log(data);
                let btn = $(this);
                btn.append(` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`);

                $.ajax({
                    url: '@Url.Action("DeleteReportForm", "InspectionPlan_Management")',
                    data: JSON.stringify(data),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

                function onSuccess(res) {
                    console.log(res);
                    btn.children(".spinner-border").remove();
                    bootstrap.Modal.getInstance(modal[0]).hide();

                    createDialogModal({
                        id: "DialogModal-Success",
                        inner: "刪除成功！",
                    })

                    res.forEach((d) => { E_RDG.datagrid("deleteRow", E_RDG.datagrid("getRowIndex", d.RSN)) })

                    reloadDeviceData();

                    E_RDG.datagrid("clearChecked");

                    if (E_RDG.datagrid("getRows").length === 0) {
                        changeEditAreaCss.call($("#Repair-create")[0], true)
                    }
                }
                function onError(err) {
                    btn.children(".spinner-border").remove();
                    createDialogModal({
                        id: "DialogModal-Error",
                        inner: "刪除失敗！",
                    })
                    E_RDG.datagrid("clearChecked");
                }
            }
        }

        function changeEditAreaCss(reserve = false) {

            let selfJQ = $(this);
            let parent = selfJQ.parent();

            if (reserve) {
                selfJQ.siblings().addClass("d-none");
                parent.addClass("mt-0");
                parent.siblings(".datatable-easyui").addClass("d-none");
                parent.siblings(".form-group").addClass("d-none");
                return;
            }

            selfJQ.siblings().removeClass("d-none");
            parent.removeClass("mt-0");
            parent.siblings(".datatable-easyui").removeClass("d-none");
            parent.siblings(".form-group").removeClass("d-none");
        }
        function loadDatagrid(id) {
            let dg = $(`#${id} .modal-datagrid`);
            dg.datagrid("load", getQueryParams(`#${id} form`));
        }
        function getCheckbox(dg, index) {
            return dg.datagrid('getPanel').find('.datagrid-row [field="_select"]')[index].querySelector(".datagrid-cell-check");
        }
        function getChecked(dg, index) {
            let dom = getCheckbox(dg, index);
            return dom ? dom.checked : null;
        }
        function onSelectBtn(dg, index, sc) {
            if (sc !== null && sc == getChecked(dg, index)) {
                sc = null;
                return false;
            }
            return true;
        }
        function onBeforeSelect(dg, index, sc, bool) {
            if (getCheckbox(dg, index) == null) return bool;
            return onSelectBtn(dg, index, sc);
        }

        function getDeviceData(data) {
            let ESNDatas = JSON.parse(sessionStorage.getItem(`ESNDatas`));
            let postData;
            if (ESNDatas) {
                postData = new Set(data.map(d => d.ESN).filter(e => !ESNDatas.includes(e)))
            }
            else {
                postData = new Set(data.map(d => d.ESN));
            }

            if (postData.size !== 0) {
                $.ajax({
                    url: '@Url.Action("ResponseDeviceInfo", "InspectionPlan_Management")',
                    data: JSON.stringify([...postData]),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: (res) => {
                        console.log("getDeviceData onSuccess", res)

                        storeESNData(postData, ESNDatas);
                        storeDeviceData(res.DeviceData);
                    },
                    error: (err) => { console.log(err) }
                })
            }
        }

        function reloadDeviceData() {
            if (!$(".sample-path-draw-area").hasClass('d-none')) {
                let pathID = $("#PathID").val();
                ForgeDraw.removeAllDevice();

                let pathData = JSON.parse(sessionStorage.getItem(`P${pathID}_pathData`));
                readBeaconData(pathData.PathSample.Beacon);
                readDeviceData(pathID);

                calcRoute();
            }
        }

        function storeESNData(postData, ESNDatas) {
            let esnSet;
            if (ESNDatas) {
                esnSet = new Set([...postData, ...ESNDatas]);
            }
            else {
                esnSet = postData;
            }
            sessionStorage.setItem(`ESNDatas`, JSON.stringify([...esnSet]));
        }

        function storeDeviceData(data) {
            let DeviceDatas = JSON.parse(sessionStorage.getItem(`DeviceDatas`)) ?? {};
            for (let i = 0; i < data.length; i++) {
                let e = data[i];

                DeviceDatas[e.ASN] ?? (DeviceDatas[e.ASN] = {})
                DeviceDatas[e.ASN][e.FSN] ?? (DeviceDatas[e.ASN][e.FSN] = {})
                DeviceDatas[e.ASN][e.FSN][e.ESN] = filterData(e);
            }

            sessionStorage.setItem(`DeviceDatas`, JSON.stringify(DeviceDatas));

            function filterData(d) {
                let fos = d.Position ? new THREE.Vector3(d.Position.LocationX, d.Position.LocationY, 0) : undefined;
                let pos = fos ? viewer.worldToClient(fos) : undefined;
                return {
                    dbId: d.DBID,
                    deviceType: "device",
                    deviceName: d.ESN,
                    position: pos ? new PIXI.Point(pos.x, pos.y) : undefined,
                    forgePos: fos
                }
            }
        }
        return this;
    }

    function addTooltip() {
        let tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        let tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                customClass: "sample-path-tooltip",
            })
        })
    }

    function savePath() {
        let pathID = $("#PathID").val()
        let pathData = JSON.parse(sessionStorage.getItem(`P${pathID}_pathData`))
        let title = $("#current-PathTitle").val()
        let PathSampleOrder = $("#current-path-display .breadcrumb-item").toArray().map(e => e.innerHTML);
        let PathSampleRecord = ForgeDraw.getForgeLineData().map(e => {
            return { LocationX: e.x, LocationY: e.y };
        })
        pathData.PathSample.PathTitle = title;
        pathData.PathSampleOrder = PathSampleOrder;
        pathData.PathSampleRecord = PathSampleRecord;
        sessionStorage.setItem(`P${pathID}_pathData`, JSON.stringify(pathData))
    }

    function loadPath(pathID) {
        $("#PathID").val(pathID);
        ForgeDraw.removeAllDevice();
        ForgeDraw.removeAllData();
        ForgeDraw.clearSelectPos();

        let pathData = JSON.parse(sessionStorage.getItem(`P${pathID}_pathData`))
        $("#current-PathTitle").val(pathData.PathSample.PathTitle);
        //開啟forge顯示
        $(".sample-path-draw-area").removeClass('d-none')
        togglePointerEvent(false);

        viewer.loadModel(viewerUrl, { keepCurrentModels: false },
            onSuccess, (err) => { console.log(err) }
        );

        function onSuccess(res) {
            $(viewer).one(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, function () {
                $(viewer).one(Autodesk.Viewing.FINAL_FRAME_RENDERED_CHANGED_EVENT, function () {
                    readBeaconData(pathData.PathSample.Beacon);
                    readDeviceData(pathID);
                    readPathData(pathData.PathSampleRecord);
                    updatePathDisplay(pathData.PathSampleOrder);

                    calcRoute();
                    togglePointerEvent(true);
                })
            })
        }
    }

    function togglePointerEvent(bool) {
        $(".btn").toggleClass("pe-none", !bool);
        $(".path-btn").toggleClass("pe-none", !bool);
        $(".path-icon").toggleClass("pe-none", !bool);
        $(".btn-delete-item").toggleClass("pe-none", !bool);
    }

    function save() {
        let PathSampleOrder = $(".breadcrumb-item:not(:first-child):not(:last-child)").toArray().map(e => e.innerHTML);
        let PathSampleRecord = ForgeDraw.getForgeLineData().map(e => {
            return { LocationX: e.x, LocationY: e.y };
        })

        let data = {
            PathSample: {
                ASN: $("#ASN").val(),
                FSN: $("#FSN").val(),
                PathTitle: $("#PathTitle").val()
            },
            PathSampleOrder: PathSampleOrder,
            PathSampleRecord: PathSampleRecord
        }

        console.log(data);

        /* $.ajax({
            url: '@Url.Action("aaa", "bbb")',
            data: JSON.stringify(data),
            type: "POST",
            dataType: "json",
            contentType: "application/json;charset=utf-8",
            success: onSuccess,
            error: onError
        }) */

        function onSuccess(res) {
            console.log(res);
            createDialogModal({
                id: "DialogModal-Success", inner: "新增成功！",
                onHide: () => { window.location.href = '@Url.Action("Management", "InspectionPlan_Management")'; }
            });
        }
        function onError(res) {
            console.log(res);
            createDialogModal({ id: "DialogModal-Error", inner: `新增失敗！` })
        }
    }
</script>