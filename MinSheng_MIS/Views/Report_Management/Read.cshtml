@{
    ViewBag.Title = "報修單詳情";
}

<h2>@ViewBag.Title</h2>

<div class="datatable mt-5">
    <div class="datatable-header">報修資料</div>
    <div class="datatable-body">
        <table class="datatable-table" id="ReportDetail"></table>
    </div>
</div>

<div class="datatable datatable-secondary mt-5 d-none" id="InspectionPlan_List">
    <div class="datatable-header">本報修單相關維修紀錄</div>
    <div class="datatable-body">
        <div class="accordion accordion-flush datatable-accordion" id="accordion-InspectionPlan">
            @* <div class="accordion-item" id="InspectionPlan-1">
            <h2 class="accordion-header" id="header-InspectionPlan-1">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
            data-bs-target="#body-InspectionPlan-1" aria-expanded="false"
            aria-controls="body-InspectionPlan-1">
            P23011701-巡檢AB區計畫
            </button>
            </h2>
            <div id="body-InspectionPlan-1" class="accordion-collapse collapse"
            aria-labelledby="header-InspectionPlan-1">
            <div class="accordion-body">
            <div class="datatable border-0 w-100">
            <div class="datatable-header">計劃資訊</div>
            <div class="datatable-body">
            <table class="datatable-table" id="InspectionPlan">
            <tr>
            <td class="datatable-table-th">text</td>
            <td>value</td>
            </tr>
            </table>
            </div>
            </div>
            <div class="datatable border-0 w-100">
            <div class="datatable-header">維修資料</div>
            <div class="datatable-body">
            <table class="datatable-table" id="InspectionPlanRepair">
            <tr>
            <td class="datatable-table-th">text</td>
            <td>value</td>
            </tr>
            <tr>
            <td class="datatable-table-th">img</td>
            <td>value</td>
            </tr>
            </table>
            </div>
            </div>
            <div class="datatable border-0 w-100">
            <div class="datatable-header">補件資料</div>
            <div class="datatable-body" id="RepairSupplementaryInfo_List">
            <div class="accordion accordion-flush datatable-accordion"
            id="accordion-RepairSupplementaryInfo">
            <div class="accordion-item" id="RepairSupplementaryInfo-1">
            <h2 class="accordion-header" id="header-RepairSupplementaryInfo-1">
            <button class="accordion-button collapsed" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#body-RepairSupplementaryInfo-1" aria-expanded="false"
            aria-controls="body-RepairSupplementaryInfo-1">
            2023/1/15補件
            </button>
            </h2>
            <div id="body-RepairSupplementaryInfo-1" class="accordion-collapse collapse"
            aria-labelledby="header-RepairSupplementaryInfo-1">
            <div class="accordion-body">
            <div class="datatable border-0 w-100">
            <div class="datatable-body">
            <table class="datatable-table" id="RepairSupplementaryInfo">
            <tr>
            <td class="datatable-table-th">text</td>
            <td>value</td>
            </tr>
            </table>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            <div class="datatable border-0 w-100">
            <div class="datatable-header">審核資料</div>
            <div class="datatable-body" id="RepairAuditInfo_List">
            <div class="accordion accordion-flush datatable-accordion"
            id="accordion-RepairAuditInfo">
            <div class="accordion-item" id="RepairAuditInfo-1">
            <h2 class="accordion-header" id="header-RepairAuditInfo-1">
            <button class="accordion-button collapsed" type="button"
            data-bs-toggle="collapse" data-bs-target="#body-RepairAuditInfo-1"
            aria-expanded="false" aria-controls="body-RepairAuditInfo-1">
            2023/1/8 審核
            </button>
            </h2>
            <div id="body-RepairAuditInfo-1" class="accordion-collapse collapse"
            aria-labelledby="header-RepairAuditInfo-1">
            <div class="accordion-body">
            <div class="datatable border-0 w-100">
            <div class="datatable-body">
            <table class="datatable-table" id="RepairAuditInfo">
            <tr>
            <td class="datatable-table-th">text</td>
            <td>value</td>
            </tr>
            </table>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div>
            </div> *@
        </div>
    </div>
</div>

<script src="/Scripts/datatable.js"></script>
<script src="/Scripts/ImageDisplay.js"></script>
<script>

    const RSN = '@ViewBag.id';
    let apiUrl = '@Url.Action("ReadBody", "Report_Management")' + `/${RSN}`;
    const SerializedName = [
        { text: "報修單號", value: "RSN" },
        { text: "報修時間", value: "Date" },
        { text: "報修等級", value: "ReportLevel" },
        { text: "報修人員", value: "MyName" },
        { text: "本報修單狀態", value: "ReportState" },
        { text: "區域", value: "Area" },
        { text: "樓層", value: "Floor" },
        { text: "國有財產編碼", value: "PropertyCode" },
        { text: "設備編號", value: "ESN" },
        { text: "設備名稱", value: "EName" },
        { text: "報修說明", value: "ReportContent" },
        { text: "報修照片", value: "ImgPath" },
    ]
    const fakeData2 = {
        "RSN": "R23022001",
        "Date": "2023/2/20 09:00:00",
        "ReportLevel": "施工中",
        "MyName": "賈皓麟",
        "ReportState": "審核未過",
        "Area": "前處理機房",
        "Floor": "B1F",
        "PropertyCode": "35435",
        "ESN": "E00003",
        "EName": "粗攔物除物皮帶輸送機",
        "ReportContent": "壞透透",
        "ImgPath": [
            "C:/Users/User/Pictures/安妮雅.jfif"
        ],
        "InspectionPlanList": [
            {
                "InspectionPlan": {
                    "IPSN": "P23022203",
                    "IPName": "維修設備E00003",
                    "PlanDate": "2023/2/22",
                    "PlanState": "巡檢完成",
                    "Shift": "2",
                    "MyName": "賈皓麟、羅紹齊"
                },
                "InspectionPlanRepair": {
                    "RepairState": "審核未過",
                    "RepairContent": "好了",
                    "MyName": "賈皓麟",
                    "RepairDate": "2023/2/22",
                    "ImgPath": []
                },
                "RepairSupplementaryInfo": [],
                "RepairAuditInfo": [
                    {
                        "MyName": "陳進國",
                        "AuditDate": "2023/2/22",
                        "AuditResult": "審核未過",
                        "AuditMemo": "沒修好",
                        "ImgPath": []
                    }
                ]
            },
            {
                "InspectionPlan": {
                    "IPSN": "P23022301",
                    "IPName": "再次維修設備E00003",
                    "PlanDate": "2023/2/23",
                    "PlanState": "巡檢完成",
                    "Shift": "2",
                    "MyName": "賈皓麟、羅紹齊"
                },
                "InspectionPlanRepair": {
                    "RepairState": "審核未過",
                    "RepairContent": "好了",
                    "MyName": "賈皓麟",
                    "RepairDate": "2023/2/23",
                    "ImgPath": []
                },
                "RepairSupplementaryInfo": [],
                "RepairAuditInfo": [
                    {
                        "MyName": "陳進國",
                        "AuditDate": "2023/2/23",
                        "AuditResult": "審核未過",
                        "AuditMemo": "還是沒修好",
                        "ImgPath": []
                    }
                ]
            }
        ]
    }
    const fakeData = {
        RSN: "R23010601",
        Date: "2023/1/6 15:00:02",
        ReportLevel: "最速件",
        MyName: "王大明",
        ReportState: "已派工",
        Area: "A棟",
        Floor: "1F",
        PropertyCode: "無",
        ESN: "E00001",
        EName: "日光燈",
        ReportContent: "故障",
        ImgPath: [
            "/Content/img/bg.png",
            "/Content/img/bg.png",
            "/Content/img/bg.png",
            "/Content/img/bg.png",
        ],
        InspectionPlanList: [
            {
                InspectionPlan: {
                    IPSN: "P23010401",
                    IPName: "巡檢A區計畫",
                    PlanDate: "2023/1/8",
                    PlanState: "巡檢完成",
                    Shift: "早班",
                    MyName: "王大明、李泰順",
                },
                InspectionPlanRepair: {
                    RepairState: "完成",
                    RepairContent: "修復完成",
                    MyName: "王大明",
                    RepairDate: "2023/1/7 12:40:56",
                    ImgPath: [
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                    ],
                },
                RepairSupplementaryInfo: [
                    {
                        MyName: "王大明",
                        SupplementaryDate: "2023/1/15",
                        SupplementaryContent: "OOXX",
                        FilePath: ["/file/電燈故障.pdf"],
                    },
                    {
                        MyName: "王大明",
                        SupplementaryDate: "2023/1/15",
                        SupplementaryContent: "OOXX",
                        FilePath: ["/file/電燈故障.pdf", "/file/電燈故障2.pdf"],
                    },
                ],
                RepairAuditInfo: [
                    {
                        MyName: "陳組長",
                        AuditDate: "2023/1/15",
                        AuditResult: "審核未過",
                        AuditMemo: "未處理完善",
                        ImgPath: [
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                        ],
                    },
                    {
                        MyName: "陳組長",
                        AuditDate: "2023/1/15",
                        AuditResult: "審核未過",
                        AuditMemo: "未處理完善",
                        ImgPath: [
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                        ],
                    },
                ],
            },
            {
                InspectionPlan: {
                    IPSN: "P23010402",
                    IPName: "巡檢A區計畫",
                    PlanDate: "2023/1/9",
                    PlanState: "巡檢完成",
                    Shift: "早班",
                    MyName: "王大明、李泰順",
                },
                InspectionPlanRepair: {
                    RepairState: "完成",
                    RepairContent: "修復完成",
                    MyName: "王大明",
                    RepairDate: "2023/1/7 12:40:56",
                    ImgPath: [
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                        "/Content/img/bg.png",
                    ],
                },
                RepairSupplementaryInfo: [
                    {
                        MyName: "王大明",
                        SupplementaryDate: "2023/1/15",
                        SupplementaryContent: "OOXX",
                        FilePath: ["/file/電燈故障.pdf"],
                    },
                    {
                        MyName: "王大明",
                        SupplementaryDate: "2023/1/15",
                        SupplementaryContent: "OOXX",
                        FilePath: ["/file/電燈故障.pdf", "/file/電燈故障2.pdf"],
                    },
                ],
                RepairAuditInfo: [
                    {
                        MyName: "陳組長",
                        AuditDate: "2023/1/15",
                        AuditResult: "審核未過",
                        AuditMemo: "未處理完善",
                        ImgPath: [
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                        ],
                    },
                    {
                        MyName: "陳組長",
                        AuditDate: "2023/1/15",
                        AuditResult: "審核未過",
                        AuditMemo: "未處理完善",
                        ImgPath: [
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                            "/Content/img/bg.png",
                        ],
                    },
                ],
            },
        ]
    }

    function readData(url = null) {

        url == null ? onSuccess(fakeData2) :
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

        function onSuccess(res) {
            console.log(res);
            $("#ReportDetail").append(createTableInner(res, SerializedName));
            if (res.InspectionPlanList.length != 0) {
                let accordion = $("#accordion-InspectionPlan");
                res.InspectionPlanList.forEach((d, i) => {
                    accordion.append(putData_InspectionPlan(d, null, i));
                })
                $("#InspectionPlan_List").removeClass("d-none");
            }
            else {
                $("#accordion-InspectionPlan").parents(".datatable").remove();
            }

            ImageDisplay(".datatable-img-item>img");
        }
        function onError(res) {
            console.log(res);
        }
    }

    window.onload = function () {

        readData(apiUrl);
    }

</script>