@{
    ViewBag.Title = "新增出庫";
}

@section styles {
    <style>
        @@media(min-width: 992px) {
            .datatable-large {
                max-width: 100%;
                width: 1050px;
            }
        }

        .datatable:is(:has(.datatable-table tbody:empty),:has(.datatable-table:empty)){
            display: none;
        }

        .edit-area:is(:has(.datatable .datatable-table tbody:empty),:has(.datatable .datatable-table:empty))::before{
            content: "請掃瞄RFID以進行出庫作業";
            color: white;
            padding: 3rem;
        }
    </style>
}

<h2>@ViewBag.Title</h2>

<section style="max-width: 855px;margin: auto;">
    <div class="edit-area bg-transparent flex-wrap flex-md-row justify-content-lg-between" style="gap: 1rem 2rem;">
        <form class="form d-lg-contents">
            <div class="form-group w-lg-100 w-xl-250px required">
                <label for="SRSN">領用申請單號</label>
                <input class="form-control" id="SRSN" name="SRSN" type="text" maxlength="10" />
            </div>

            <div class="form-group w-lg-45 w-xl-250px required">
                <label for="StockOutUserName">出庫人員</label>
                <select class="form-select" name="StockOutUserName" id="StockOutUserName" required>
                    <option value="">請選擇</option>
                </select>
            </div>

            <div class="form-group w-lg-45 w-xl-250px required">
                <label for="ReceiverUserName">領取人員</label>
                <select class="form-select" name="ReceiverUserName" id="ReceiverUserName" required>
                    <option value="">請選擇</option>
                </select>
            </div>

            <div class="form-group w-lg-100">
                <label for="StockOutContent">說明</label>
                <input class="form-control" id="StockOutContent" name="StockOutContent" type="text" maxlength="200" />
            </div>
        </form>
    </div>
</section>

<div class="datatable datatable-large mt-5">
    <div class="datatable-body overflow-auto">
        <table class="datatable-table" id="StockItemInfo"></table>
    </div>
</div>

<div class="edit-area mt-5">
    <div class="datatable datatable-fill">
        <div class="datatable-body overflow-auto">
            <table class="datatable-table" id="StockOutItem"></table>
        </div>
    </div>
</div>


<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">新增</button>
</div>



<script src="/Scripts/datatable.js"></script>
<script src="/Scripts/tool.js"></script>
<script>

    const apiUrl = null;

    const SerializedName = {
        thead: true,
        columns: [
            { id: "PickUpStatus", title: "狀態" },
            { id: "StockType", title: "品項", width: 160 },
            { id: "StockName", title: "品名", width: 250 },
            { id: "Amount", title: "數量", width: 120 },
            { id: "TakeAmount", title: "已領取數量", width: 150 },
            { id: "RemainingAmount", title: "剩餘可領取數量", width: 150 },
            { id: "Unit", title: "單位", width: 80 },
        ]
    }

    const GridOptions = {
        thead: true,
        columns: [
            { id: "ExternalRFID", title: "RFID", width: 100 },
            { id: "StockType", title: "品項", width: 160 },
            { id: "StockName", title: "品名", width: 250 },
            { id: "MName", title: "廠商品名", width: 100 },
            { id: "Size", title: "尺寸", width: 200 },
            { id: "Brand", title: "廠商", width: 120 },
            { id: "Model", title: "型號", width: 120 },
            { id: "ExpiryDate", title: "到期日", width: 150 },
            {
                id: "OutAmount", title: "領取數量", width: 120, formatter: (val, row) => {
                    return `<input type="number" class="form-control" step="any" min="0" max="${row.RemainingAmount}" required value="${val}">`
                }
            },
            { id: "Unit", title: "單位", width: 80 },
            { id: "RemainingAmount", title: "剩餘可領取數量", width: 150 },
            {
                id: "", title: "", width: 36, formatter: (val, row, i) => {
                    return `<button type="button" class="btn-delete-item" onclick='$("#StockOutItem tr#${i}").remove()'></button>`
                }
            }
        ]
    }

    const fakeData = [
        {
            PickUpStatus: "已領取",
            StockType: "備料",
            StockName: "軸承潤滑劑",
            Amount: "1",
            TakeAmount: "1",
            RemainingAmount: "0",
            Unit: "罐",
        },
        {
            PickUpStatus: "部分領取",
            StockType: "備料",
            StockName: "藥劑-1",
            Amount: "11",
            TakeAmount: "1",
            RemainingAmount: "10",
            Unit: "罐",
        },
    ]

    const griditem = [
        {
            ExternalRFID: "A101",
            StockType: "備料",
            StockName: "藥劑-1",
            MName: "藥劑-1",
            Size: "1L",
            Brand: "OXO",
            Model: "OXO",
            ExpiryDate: "2023/03/22",
            OutAmount: "1",
            Unit: "罐",
            RemainingAmount: "6"
        },
        {
            ExternalRFID: "A101",
            StockType: "備料",
            StockName: "藥劑-1",
            MName: "藥劑-1",
            Size: "1L",
            Brand: "OXO",
            Model: "OXO",
            ExpiryDate: "2023/03/22",
            OutAmount: "1",
            Unit: "罐",
            RemainingAmount: "10"
        },
    ]

    $(async function () {
        await pushSelect("StockOutName", '@Url.Action("AllMyName", "DropDownList")');
        await pushSelect("ReceiverName", '@Url.Action("AllMyName", "DropDownList")');
        addButtonEvent();
        readData(apiUrl);
    })

    function readData(url = null) {

        url == null ? onSuccess(fakeData) :   //fakeData
            $.ajax({
                url: url,
                data: JSON.stringify(jsonData),
                type: "POST",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

        function onSuccess(res) {
            console.log(res);
            $("#StockItemInfo").append(createTableGrid(res, SerializedName));
            $("#StockOutItem").append(createTableGrid(griditem, GridOptions))
        }
        function onError(res) {
            console.log(res);
        }
    }

    function save() {
        let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
        console.log("todo save():", isValidity)
        if (!isValidity) return;
    }

    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        })

        $("#submit").click(function () {
            save();
        })
    }
</script>
