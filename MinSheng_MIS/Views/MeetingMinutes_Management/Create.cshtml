@{
    ViewBag.Title = "新增會議記錄";
}
<style>
    .mm-grid {
        grid-template-columns: repeat(12, 1fr);
        gap: 1.5rem;
    }

    @@media (max-width: 1400px) {
        .mm-grid {
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
        }
    }

    .grid-2 {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }

    .grid-3 {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
    }

    .grid .form-control {
        grid-column-start: auto;
    }

    .g-col-2 {
        grid-column: auto/span 2;
    }

    .g-col-3 {
        grid-column: auto/span 3;
    }

    .g-col-6 {
        grid-column: auto/span 6;
    }

    .textbox {
        width: 100% !important;
    }
</style>

<h2>@ViewBag.Title</h2>

<section>
    <div class="edit-area edit-area-middle px-lg-5 py-lg-4">
        <form class="d-grid mm-grid w-100">
            <div class="form-group g-col-6 required">
                <label for="MeetingTopic">會議主題</label>
                <input class="form-control" id="MeetingTopic" name="MeetingTopic" type="text" required>
            </div>
            <div class="form-group g-col-3 required">
                <label for="MeetingDate">會議日期</label>
                <input class="form-control" id="MeetingDate" name="MeetingDate" type="date" required>
            </div>
            <div class="form-group g-col-3 required">
                <label for="MeetingDateStart">會議時間</label>
                <div class="d-grid grid grid-2">
                    <input class="form-control" id="MeetingDateStart" name="MeetingDateStart" type="time"
                        placeholder="開始時間" pattern="[0-9]{2}:[0-9]{2}" required>
                    <input class="form-control" id="MeetingDateEnd" name="MeetingDateEnd" type="time" placeholder="結束時間"
                        pattern="[0-9]{2}:[0-9]{2}" required>
                </div>
            </div>

            <div class="form-group g-col-6 required">
                <label for="MeetingVenue">會議地點</label>
                <input class="form-control" id="MeetingVenue" name="MeetingVenue" type="text" required>
            </div>
            <div class="form-group g-col-3 required">
                <label for="Chairperson">會議主席</label>
                <input class="form-control" id="Chairperson" name="Chairperson" type="text" required>
            </div>
            <div class="form-group g-col-3 required">
                <label for="Participant">與會者</label>
                <input class="form-control" id="Participant" name="Participant" type="text" required>
            </div>

            <div class="form-group g-col-6 required">
                <label for="ExpectedAttendence">出席狀況</label>
                <div class="d-grid grid grid-3">
                    <input class="form-control" id="ExpectedAttendence" name="ExpectedAttendence" type="number"
                        placeholder="應到" step="1" min="0" required>
                    <input class="form-control" id="ActualAttendence" name="ActualAttendence" type="number"
                        placeholder="實到" step="1" min="0" required>
                    <input class="form-control" id="AbsenteeList" name="AbsenteeList" type="number" placeholder="缺席"
                        step="1" min="0" required>
                </div>
            </div>
            <div class="form-group g-col-3 required">
                <label for="TakeTheMinutes">會議紀錄負責人</label>
                <input class="form-control" id="TakeTheMinutes" name="TakeTheMinutes" type="text" required>
            </div>
        </form>
        <form class="w-100 d-lg-contents">
            <div class="form-group w-100 mt-4">
                <label for="Agenda">議題順序</label>
                <textarea class="w-100" name="Agenda" id="Agenda" rows="5" maxlength="256"></textarea>
            </div>
            <div class="form-group w-100">
                <label for="MeetingContent">會議內容</label>
                <textarea class="w-100" name="MeetingContent" id="MeetingContent" rows="5"></textarea>
            </div>
            <div id="FileUploader"></div>
        </form>
    </div>
</section>
<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">新增</button>
</div>
<script src="/Scripts/datatable.js"></script>
<script src="/Scripts/tool.js"></script>
<script>
    var fileUploader
    $(async function () {
        addButtonEvent();
        fileUploader = new FileUploader({
            container: "#FileUploader",
            className: "form-group w-100",
            label: "會議資料",
            id: "File",
            required: false
        })
    });

    function save() {
        let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
        console.log("isValidity():", isValidity)
        if (!isValidity) return;

        var fd = new FormData();
        fd.append("ReportTitle", document.getElementById("ReportTitle").value);
        fd.append("ReportContent", document.getElementById("ReportContent").value);
        fd.append("YearMonth", document.getElementById("YearMonth").value);
        if (fileUploader.hasFile()) {
            form.append("ReportFile", fileUploader.getFile());
        }
        console.log(Object.fromEntries(fd.entries()));
        $.ajax({
            url: '@Url.Action("CreateMonthlyReport", "MonthlyReport_Management")',
            data: fd,
            type: "POST",
            contentType: false,
            processData: false,
            success: onSuccess,
            error: onError
        })
        function onSuccess(res) {
            console.log(res);
            createDialogModal({
                id: "DialogModal-Success", inner: "新增成功！",
                onHide: () => { window.location.href = "/MonthlyReport_Management/Management"; }
            });
        }
        function onError(res) {
            console.log(res);
            createDialogModal({ id: "DialogModal-Error", inner: `新增失敗！` + `${res.responseText}` })
        }
    }

    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        })

        $("#submit").click(function () {
            save();
        })
    }
</script>