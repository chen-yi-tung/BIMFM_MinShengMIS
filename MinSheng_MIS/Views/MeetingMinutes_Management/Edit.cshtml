@{
    ViewBag.Title = "編輯會議記錄";
}
@section styles {
    <script src="/Scripts/datatable.js" defer></script>
    <script src="/Scripts/tool.js" defer></script>
    <style>
        .mm-grid {
            grid-template-columns: repeat(12, 1fr);
            gap: 1.5rem;
        }

        @@media (max-width: 1200px) {
            .mm-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 1rem;
            }
        }

        .grid-2 {
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .grid-3 {
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .grid .form-control {
            grid-column-start: auto;
        }

        .g-col-2 {
            grid-column: auto/span 2;
        }

        .g-col-3 {
            grid-column: auto/span 3;
        }

        .g-col-6 {
            grid-column: auto/span 6;
        }

        .textbox {
            width: 100% !important;
        }
    </style>
}

<h2>@ViewBag.Title</h2>

<section>
    <div class="edit-area edit-area-middle px-lg-5 py-lg-4">
        <form class="d-grid mm-grid w-100">
            <div class="form-group g-col-6 required">
                <label for="MeetingTopic">會議主題</label>
                <input class="form-control" id="MeetingTopic" name="MeetingTopic" type="text" required>
            </div>
            <div class="form-group g-col-6 required">
                <label for="MeetingVenue">會議地點</label>
                <input class="form-control" id="MeetingVenue" name="MeetingVenue" type="text" required>
            </div>
            <div class="form-group g-col-6 required">
                <label for="MeetingDate">會議日期</label>
                <div style="position: relative; overflow: hidden;">
                    <input class="form-control calendar-input" id="MeetingDate" name="MeetingDate" type="text" placeholder="年-月-日" readonly disabled />
                </div>
            </div>
            <div class="form-group g-col-6 required">
                <label for="MeetingDateStart">會議時間</label>
                <div class="d-grid grid grid-2">
                    <input class="form-control" id="MeetingDateStart" name="MeetingDateStart" type="time"
                        placeholder="開始時間" pattern="[0-9]{2}:[0-9]{2}" readonly disabled>
                    <input class="form-control" id="MeetingDateEnd" name="MeetingDateEnd" type="time" placeholder="結束時間"
                        pattern="[0-9]{2}:[0-9]{2}" readonly disabled>
                </div>
            </div>

            <div class="form-group g-col-3 required">
                <label for="Chairperson">會議主席</label>
                <input class="form-control" id="Chairperson" name="Chairperson" type="text" required>
            </div>

            <div class="form-group g-col-3 required">
                <label for="TakeTheMinutes">會議紀錄負責人</label>
                <input class="form-control" id="TakeTheMinutes" name="TakeTheMinutes" type="text" required>
            </div>

            <div class="form-group g-col-6 required">
                <label for="ExpectedAttendence">出席狀況</label>
                <div class="d-grid grid grid-3">
                    <input class="form-control" id="ExpectedAttendence" name="ExpectedAttendence" type="number"
                        placeholder="應到" step="1" min="0" required>
                    <input class="form-control" id="ActualAttendence" name="ActualAttendence" type="number"
                        placeholder="實到" step="1" min="0" required>
                    <input class="form-control" id="AbsenteeList" name="AbsenteeList" type="number" placeholder="缺席"
                        step="1" min="0" required>
                </div>
            </div>

        </form>
        <form class="w-100 d-lg-contents">
            <div class="form-group w-100 mt-4 required">
                <label for="Participant">與會者</label>
                <input class="form-control" id="Participant" name="Participant" type="text" required>
            </div>
            <div class="form-group w-100 mt-4">
                <label for="Agenda">議題順序</label>
                <textarea class="w-100" name="Agenda" id="Agenda" rows="5" maxlength="256"></textarea>
            </div>
            <div class="form-group w-100">
                <label for="MeetingContent">會議內容</label>
                <textarea class="w-100" name="MeetingContent" id="MeetingContent" rows="5"></textarea>
            </div>
            <div id="FileUploader"></div>
        </form>
    </div>
</section>
<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">儲存</button>
</div>

@section scripts {
    <script>
        const MMSN = '@ViewBag.id';
        let apiUrl = '@Url.Action("EditReadBody", "MeetingMinutes_Management")' + `/${MMSN}`;
        //let apiUrl = null;

        const fakeData = {
            MeetingTopic: "修改日期指定",
            MeetingDate: "2024-01-01",
            MeetingDateStart: "10:00",
            MeetingDateEnd: "11:00",
            MeetingVenue: "會議室3B",
            Chairperson: "李助理",
            Participant: "全體人員",
            ExpectedAttendence: "53",
            ActualAttendence: "53",
            AbsenteeList: "0",
            TakeTheMinutes: "助理",
            Agenda: "文字內容",
            MeetingContent: "電腦筆記",
            FilePath: "5月主題.pdf"
        }

        var fileUploader
        $(async function () {
            addButtonEvent();
            fileUploader = new FileUploader({
                container: "#FileUploader",
                className: "form-group w-100",
                label: "會議資料",
                id: "File",
                required: false
            })
            readData(apiUrl)
        });

        function readData(url = null) {

            url == null ? onSuccess(fakeData) :
                $.ajax({
                    url: url,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

            function onSuccess(res) {
                console.log(res);
                res.MeetingDate = dateTransform(res.MeetingDate);
                for (const [k, v] of Object.entries(res)) {
                    $("#" + k).val(v) 
                }
                res.FilePath ? fileUploader.setFile(res.FilePath) : void 0
                document.querySelector('.datepick-trigger').style.display = "none";
            }
            function onError(res) {
                console.log(res);
            }
        }

        function save() {
            //重置自訂驗證錯誤訊息
            getAllParams().forEach((e) => {
                e.setCustomValidity('');
            })
            //自訂驗證錯誤
            fileUploader.setExtensionValidity(fileUploader.checkAllExtension())
            let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
            console.log("isValidity():", isValidity)
            if (!isValidity) return;

            var fd = new FormData();
            fd.append("MMSN", MMSN);
            fd.append("MeetingTopic", document.getElementById("MeetingTopic").value);

            let MeetingDateValue = dateTransform({ MeetingDate: document.getElementById("MeetingDate").value });
            fd.append("MeetingDate", MeetingDateValue.MeetingDate);
            fd.append("MeetingDateStart", document.getElementById("MeetingDateStart").value);
            fd.append("MeetingDateEnd", document.getElementById("MeetingDateEnd").value);

            fd.append("MeetingVenue", document.getElementById("MeetingVenue").value);
            fd.append("Chairperson", document.getElementById("Chairperson").value);
            fd.append("Participant", document.getElementById("Participant").value);
            fd.append("ExpectedAttendence", document.getElementById("ExpectedAttendence").value);
            fd.append("ActualAttendence", document.getElementById("ActualAttendence").value);
            fd.append("AbsenteeList", document.getElementById("AbsenteeList").value);

            fd.append("TakeTheMinutes", document.getElementById("TakeTheMinutes").value);
            fd.append("Agenda", document.getElementById("Agenda").value);
            fd.append("MeetingContent", document.getElementById("MeetingContent").value);
            if (fileUploader.hasFile()) {
                let file = fileUploader.getFile()
                if (file?.size) {
                    fd.append(`MeetingFile`, file);
                }
                else {
                    fd.append(`MeetingFileName`, file?.name);
                }
            }
            console.log(Object.fromEntries(fd.entries()));
            $.ajax({
                url: '@Url.Action("EditMeetingMinutes", "MeetingMinutes_Management")',
                data: fd,
                type: "POST",
                contentType: false,
                processData: false,
                success: onSuccess,
                error: onError
            })
            function onSuccess(res) {
                console.log(res);
                createDialogModal({
                    id: "DialogModal-Success", inner: "儲存成功！",
                    onHide: () => { window.location.href = "/MeetingMinutes_Management/Index"; }
                });
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `儲存失敗！` + `${res?.responseText || ""}` })
            }
        }

        function addButtonEvent() {
            $("#back").click(function () {
                history.back();
            })

            $("#submit").click(function () {
                save();
            })
        }
    </script>
}