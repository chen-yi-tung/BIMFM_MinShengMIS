@{
    ViewBag.Title = "報修管理";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <script src="/Scripts/Repair_Management/Index.js" defer></script>
    <link rel="stylesheet" href="/Content/tagbox.css">
}

<h2>@ViewBag.Title</h2>

<div class="dg-tool-bar">
    <button type="button" class="btn btn-create" id="create">新增報修</button>
    <div class="search-area">
        <form class="form" method="post" action="" id="form">
            <div class="form-group">
                <label for="ReportState">報修單狀態</label>
                <select class="form-select" name="ReportState" id="ReportState"></select>
            </div>

            <div class="form-group">
                <label for="RSN">報修單號</label>
                <input class="form-control" id="RSN" name="RSN" type="text" />
            </div>

            <div class="form-group">
                <label for="ReportLevel">報修等級</label>
                <select class="form-select" name="ReportLevel" id="ReportLevel"></select>
            </div>

            <div class="form-group">
                <label for="DateFrom">報修時間(起)</label>
                <input class="form-control" id="DateFrom" name="DateFrom" type="date" />
            </div>

            <div class="form-group">
                <label for="DateTo">報修時間(迄)</label>
                <input class="form-control" id="DateTo" name="DateTo" type="date" />
            </div>

            <div class="form-group">
                <label for="ReportContent">報修內容</label>
                <input class="form-control" id="ReportContent" name="ReportContent" type="text" />
            </div>

            <div class="form-group">
                <label for="ASN">棟別</label>
                <select class="form-select" name="ASN" id="ASN"></select>
            </div>

            <div class="form-group">
                <label for="FSN">樓層</label>
                <select class="form-select" name="FSN" id="FSN"></select>
            </div>

            <div class="form-group">
                <label for="EName">設備名稱</label>
                <input class="form-control" id="EName" name="EName" type="text" />
            </div>

            <div class="form-group">
                <label for="NO">設備編號</label>
                <input class="form-control" id="NO" name="NO" type="text" />
            </div>

            <div class="form-group">
                <label for="Member">執行人員</label>
                <select type="text" class="form-select" name="Member" id="Member"></select>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-search" id="search">查詢</button>
                <button type="reset" class="btn btn-clear" id="clear">清除</button>
                <button type="button" class="btn btn-export" id="export">匯出</button>
            </div>

        </form>
    </div>
    <button type="button" class="btn btn-other" id="multiAssign">批量派工</button>
    <div class="datagrid-area">
        <table id="DataGrid"></table>
    </div>
</div>


@*派工POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="addMultiAssign">
    <div class="modal-dialog modal-screen-md modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>報修單 派工</h2>
                <form class="form w-100 p-0">
                    <div class="form-group-zone">
                        <div class="form-group col-3fr required">
                            <label for="DueDate">預計維修日期</label>
                            <input type="date" class="form-control" name="DueDate" id="DueDate" maxlength="20" required>
                        </div>
                        <div class="form-group col-3fr required">
                            <label for="RepairUserName">執行人員</label>
                            <select type="text" class="form-select repair-user-name" name="RepairUserName" id="RepairUserName"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="submit">確定</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var getGridJSON = '@Url.Action("ManagementDataGrid", "Repair_Management")';
        var DataGrid;
        let currentRSN = "";

        const fakedata = [
            {
                ReportState: "待派工",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "待執行",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "待審核",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "審核通過",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "審核未過",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
        ]

        let authority;
        $(async function () {
            //取得權限
            (async () => {
                try {
                    authority = await checkAuthority('@Url.Action("UserAuthority", "Account")');
                    console.log("權限", authority);
                } catch (error) {
                    console.error("權限回傳失敗", error);
                }
            })();
            await formDropdown.ASN();
            await pushSelect("ReportState", '@Url.Action("ReportState", "DropDownList")');
            await pushSelect("ReportLevel", '@Url.Action("ReportLevel", "DropDownList")');
            await pushSelect("Member", '@Url.Action("RepairUserName", "DropDownList")');
            await addDropDownList();
            await addButtonEvent();
            Initialize_DataGrid(getGridJSON, authority);
            addSearchAreaClickEvent();

            if (authority === "3") {
                document.getElementById('multiAssign').classList.add('d-none');
                document.getElementById('create').classList.add('d-none');
            }
        });

        function Initialize_DataGrid(getGridJSON, authority) {
            let dg = new DG();
            DataGrid = dg.init("#DataGrid", {
                url: getGridJSON,
                //data: fakedata,
                method: 'POST',
                queryParams: getQueryParams(),
                idField: 'RSN',
                singleSelect: false,
                frozenColumns: [[
                    { field: 'ck', checkbox: true }, // 新增 checkbox
                    dg.frozenColumn('_detail', (v, row, i) => dg.eventButton(i, "詳情", "detail")),
                    dg.frozenColumn('_review', (v, row, i) => dg.eventButton(i, "審核", "review", { disabled: row.ReportState != "待審核" || authority != "1" })),
                    dg.frozenColumn('_assign', (v, row, i) => dg.eventButton(i, "派工", "assign", { disabled: row.ReportState != "待派工" || authority === "3", className: "btn btn-datagrid btn-other", dataTitle: "報修單 派工" })),
                    //dg.frozenColumn('_assign', (v, row, i) =>
                    //    `<button onclick="dg.eventButton(${i}, '派工', '_assign')" ${row.ReportState !== "待派工" ? "disabled" : ""} class="btn btn-datagrid btn-other" data-bs-toggle="modal" data-bs-target="#addMultiAssign" data-title="報修單 派工">派工</button>`)
                ]],
                onLoadSuccess: function (data) {
                    const rows = data.rows;
                    rows.forEach((row, index) => {
                        if (row.ReportState !== "待派工") {
                            const checkbox = $('#DataGrid').datagrid('getPanel').find(`#DataGrid_datagrid-row-r1-1-${index} input[type="checkbox"]`);
                            checkbox.prop('disabled', true);
                        }
                    });
                },
                columns: [[
                    dg.column('ReportState', '報修單狀態', 150),
                    dg.column('RSN', '報修單號', 150),
                    dg.column('ReportLevel', '報修等級', 150),
                    dg.column('ReportTime', '報修時間', 200),
                    dg.column('ReportContent', '報修內容', 300),
                    dg.column('Area', '棟別', 200),
                    dg.column('FloorName', '樓層', 200),
                    dg.column('EName', '設備名稱', 300),
                    dg.column('NO', '設備編號', 150),
                    dg.column('RepairMyName', '執行人員', 300),
                ]]
            })
            dg.addEvent("detail", function (row, i) {
                console.log("row",row)
                window.open(`${baseUrl}/Detail?RSN=${row.RSN}`, "_blank")
            })
            dg.addEvent("review", function (row, i) {
                window.open(`${baseUrl}/Review?RSN=${row.RSN}`, "_self")
            })
            dg.addEvent("assign", function (row, i) {
                currentRSN = row.RSN;
                const modal = document.getElementById("addMultiAssign");

                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = `報修單 派工`;
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("DueDate").value = "";
                    $('#addMultiAssign #RepairUserName').tagbox('clear');
                }, { once: true })
            });
        }

        //點擊 批量派工btn
        document.getElementById("multiAssign").addEventListener("click", function () {
            currentRSN = getCheckedRSN();
            if (currentRSN.length > 0) {
                const modal = document.getElementById("addMultiAssign");
                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = "報修單 批量派工";
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("DueDate").value = "";
                    $('#addMultiAssign #RepairUserName').tagbox('clear');
                }, { once: true })
            } else {
                createDialogModal({
                    id: "DialogModal-Error", inner: `請先勾選欲派工的報修單！`,
                })
                return;
            }
        });

        //點擊 匯出btn
        $("#export").click(function () {
            const fd = new FormData();
            for (const [key, value] of Object.entries(getQueryParams('#form'))) {
                fd.append(key, value);
            }
            $.ajax({
                url: "@Url.Action("ExportToExcel", "Repair_Management")",
                data: fd,
                type: "POST",
                contentType: false,
                processData: false,
                success: onSuccess,
                error: onError,
                xhrFields: {
                    responseType: 'blob'  //指定響應類型為blob
                },
            })
            function onSuccess(res) {
                console.log("onSuccess res:", res);
                let a = document.createElement('a');
                let url = window.URL.createObjectURL(res);
                a.href = url;
                a.download = `報修單.xlsx`;
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `匯出失敗！` + `${res?.responseText || ""}` })
            }
        })

        //search area onClick Function
        function addSearchAreaClickEvent() {
            $("#search").click(function () {
                DataGrid.datagrid('load', getQueryParams());
            });

            $("#create").click(function () {
                window.open(`${baseUrl}/Create`, "_self");
            });
        }

        //取得被勾選的報修單號
        function getCheckedRSN() {
            const checkedRows = $('#DataGrid').datagrid('getChecked');
            const rsnList = checkedRows.map(row => row.RSN);
            return rsnList;
        }

        function save() {
            const repairUserNameValue = $('#addMultiAssign #RepairUserName').tagbox('getValues');
            if (!repairUserNameValue?.length) {
                alert('請選擇執行人員');
                return false;
            }
            let isValidity = $('#addMultiAssign form')[0].reportValidity()
            console.log("isValidity():", isValidity);

            if (!isValidity) return;

            const sendData = {
                RSN: currentRSN,
                DueDate: document.getElementById("DueDate").value,
                RepairUserName: $('#addMultiAssign #RepairUserName').tagbox('getValues'),
            }
            console.log("傳送的資料", sendData);


            $.ajax({
                url: "@Url.Action("Assignment", "Repair_Management")",
                data: JSON.stringify(sendData),
                type: "POST",
                contentType: "application/json",
                processData: false,
                success: onSuccess,
                error: onError
            })
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addMultiAssign'));

            function onSuccess(res) {
                modal.hide();
                console.log(res);
                createDialogModal({
                    id: "DialogModal-Success", inner: "派工成功！",
                    onHide: () => { window.location.href = "/Repair_Management/Index"; }
                });
            }
            function onError(res) {
                modal.hide();
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `派工失敗！` + `${res?.responseText || ""}` })
            }
        }
    </script>
}
