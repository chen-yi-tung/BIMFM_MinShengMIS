@{
    ViewBag.Title = "報修管理";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <script src="/Scripts/Repair_Management/Index.js" defer></script>
    <link rel="stylesheet" href="/Content/tagbox.css">
}

<h2>@ViewBag.Title</h2>

<div class="dg-tool-bar">
    <button type="button" class="btn btn-create" id="create">新增報修</button>
    <div class="search-area">
        <form class="form" method="post" action="" id="form">
            <div class="form-group">
                <label for="ReportState">報修單狀態</label>
                <select class="form-select" name="ReportState" id="ReportState"></select>
            </div>

            <div class="form-group">
                <label for="RSN">報修單號</label>
                <input class="form-control" id="RSN" name="RSN" type="text" />
            </div>

            <div class="form-group">
                <label for="ReportLevel">報修等級</label>
                <select class="form-select" name="ReportLevel" id="ReportLevel"></select>
            </div>

            <div class="form-group">
                <label for="DateFrom">報修時間(起)</label>
                <div style="position: relative; overflow: hidden;">
                    <input class="form-control calendar-input" id="DateFrom" name="DateFrom" type="text"
                        placeholder="年-月-日" />
                </div>
            </div>

            <div class="form-group">
                <label for="DateTo">報修時間(迄)</label>
                <div style="position: relative; overflow: hidden;">
                    <input class="form-control calendar-input" id="DateTo" name="DateTo" type="text"
                        placeholder="年-月-日" />
                </div>
            </div>

            <div class="form-group">
                <label for="ReportContent">報修內容</label>
                <input class="form-control" id="ReportContent" name="ReportContent" type="text" />
            </div>

            <div class="form-group">
                <label for="ASN">棟別</label>
                <select class="form-select" name="ASN" id="ASN"></select>
            </div>

            <div class="form-group">
                <label for="FSN">樓層</label>
                <select class="form-select" name="FSN" id="FSN"></select>
            </div>

            <div class="form-group">
                <label for="EName">設備名稱</label>
                <input class="form-control" id="EName" name="EName" type="text" />
            </div>

            <div class="form-group">
                <label for="NO">設備編號</label>
                <input class="form-control" id="NO" name="NO" type="text" />
            </div>

            <div class="form-group">
                <label for="Member">執行人員</label>
                <select type="text" class="form-select" name="Member" id="Member"></select>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-search" id="search">查詢</button>
                <button type="reset" class="btn btn-clear" id="clear">清除</button>
                <button type="button" class="btn btn-export" id="export">匯出</button>
            </div>

        </form>
    </div>
    <button type="button" class="btn btn-other" id="multiAssign">批量派工</button>
    <div class="datagrid-area">
        <table id="DataGrid"></table>
    </div>
</div>


@*派工POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="addMultiAssign">
    <div class="modal-dialog modal-screen-md modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>報修單 派工</h2>
                <form class="form w-100 p-0">
                    <div class="form-group-zone">
                        <div class="form-group col-3fr required">
                            <label for="DueDate">預計維修日期</label>
                            <div style="position: relative; overflow: hidden;">
                                <input class="form-control calendar-input" id="DueDate" name="DueDate" type="text"
                                    placeholder="年-月-日" maxlength="20" required />
                            </div>
                        </div>
                        <div class="form-group col-3fr required">
                            <label for="RepairUserName">執行人員</label>
                            <select type="text" class="form-select repair-user-name" name="RepairUserName"
                                id="RepairUserName"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="submit">確定</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var getGridJSON = '@Url.Action("ManagementDataGrid", "Repair_Management")';
        var DataGrid;
        let checkedArray = [];

        const fakedata = [
            {
                ReportState: "待派工",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "待執行",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "待審核",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "審核通過",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
            {
                ReportState: "審核未過",
                RSN: "P23010401",
                ReportLevel: '最速件',
                ReportTime: "2023/01/04 16:55",
                ReportContent: "已完成螺旋機電池更換，經測試後可正常操作",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                NO: "32369304",
                RepairUserName: "王大明、李泰順",
            },
        ]

        $(async function () {
            if (!isAuth("1", "2")) {
                document.getElementById('create').remove();
                document.getElementById('multiAssign').remove();
            }

            await formDropdown.ASN();
            await formDropdown.pushSelect({ id: "ReportState", url: '@Url.Action("ReportState", "DropDownList")' });
            await formDropdown.pushSelect({ id: "ReportLevel", url: '@Url.Action("ReportLevel", "DropDownList")' });
            await formDropdown.pushSelect({ id: "Member", url: '@Url.Action("RepairUserName", "DropDownList")' });
            await addDropDownList();
            await addButtonEvent();
            Initialize_DataGrid(getGridJSON);
            addSearchAreaClickEvent();
        });

        function Initialize_DataGrid(getGridJSON) {
            let dg = new DG();
            DataGrid = dg.init("#DataGrid", {
                url: getGridJSON,
                method: 'POST',
                queryParams: getQueryParams(),
                remoteSort: true,
                singleSelect: false,
                //checkOnSelect: true,
                frozenColumns: [[
                    { field: 'ck', checkbox: true }, // 新增 checkbox
                    dg.frozenColumn('_detail', (v, row, i) => dg.eventButton(i, "詳情", "detail")),
                    isAuth("1") && dg.frozenColumn('_review', (v, row, i) => dg.eventButton(i, "審核", "review", { disabled: row.ReportState != "待審核" })),
                    isAuth("1", "2") && dg.frozenColumn('_assign', (v, row, i) => dg.eventButton(i, "派工", "assign", { disabled: row.ReportState != "待派工", className: "btn btn-datagrid btn-other", dataTitle: "報修單 派工" })),
                ]],
                onLoadSuccess: function (data) {
                    console.log("onLoad checkedArray:", checkedArray)
                    data.rows.forEach((row, index) => {
                        if (row.ReportState !== "待派工") {
                            const checkbox = $('#DataGrid').datagrid('getPanel').find(`#DataGrid_datagrid-row-r1-1-${index} input[type="checkbox"]`);
                            checkbox.prop('disabled', true);
                            $('#DataGrid').datagrid('uncheckRow', index);
                        }
                        if (checkedArray.includes(row.RSN)) {
                            $('#DataGrid').datagrid('checkRow', index);
                        }
                    });
                    checkIfAllChecked(data);
                },
                onSelect: function (index, row) {
                    if (!checkedArray.includes(row.RSN)) {
                        checkedArray.push(row.RSN);
                    }

                    var currentData = $('#DataGrid').datagrid('getData');
                    checkIfAllChecked(currentData);
                },
                onCheckAll: function (rows) {
                    setTimeout(() => {
                        rows.forEach((row) => {
                            const index = $('#DataGrid').datagrid('getRowIndex', row);
                            if (row.ReportState !== "待派工") {
                                $('#DataGrid').datagrid('uncheckRow', index); // 取消選取該行
                            }
                            if (!checkedArray.includes(row.RSN)) {
                                checkedArray.push(row.RSN);
                            }
                            checkedArray = [...new Set(checkedArray)];
                        })
                        setTimeout(() => {
                            const checkedRows = $('#DataGrid').datagrid('getChecked');
                            const panel = $('#DataGrid').datagrid('getPanel');
                            panel.find('.datagrid-header-check input[type="checkbox"]').prop('checked', checkedRows.length > 0);
                        }, 50);
                    }, 10);
                },
                onUnselect: function (index, row) {
                    checkedArray = checkedArray.filter(item => item !== row.RSN);

                    var currentData = $('#DataGrid').datagrid('getData');
                    checkIfAllChecked(currentData);
                },
                onUnselectAll: function (rows) {
                    const currentArray = new Set(checkedArray);
                    rows.forEach((row) => {
                        if (currentArray.has(row.RSN)) {
                            currentArray.delete(row.RSN);
                        }
                    })
                    checkedArray = [...currentArray];
                },
                columns: [[
                    dg.column('ReportState', '報修單狀態', 130),
                    dg.column('RSN', '報修單號', 160),
                    dg.column('ReportLevel', '報修等級', 120),
                    dg.column('ReportTime', '報修時間', 170, (v, row, i) => {
                        return dateTransform(v);
                    }),
                    dg.column('ReportContent', '報修內容', 300),
                    dg.column('Area', '棟別', 150),
                    dg.column('FloorName', '樓層', 150),
                    dg.column('EName', '設備名稱', 250),
                    dg.column('NO', '設備編號', 150),
                    dg.column('RepairMyName', '執行人員', 300),
                ]]
            })
            dg.addEvent("detail", function (row, i) {
                window.open(`${baseUrl}/Detail?RSN=${row.RSN}`, "_blank")
            })
            dg.addEvent("review", function (row, i) {
                window.open(`${baseUrl}/Review?RSN=${row.RSN}`, "_self")
            })
            dg.addEvent("assign", function (row, i) {
                const modal = document.getElementById("addMultiAssign");

                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = `報修單 派工`;
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("DueDate").value = "";
                    $('#addMultiAssign #RepairUserName').tagbox('clear');
                }, { once: true })
            });
        }

        //點擊 批量派工btn
        document.getElementById("multiAssign").addEventListener("click", function () {
            if (checkedArray.length > 0) {
                const modal = document.getElementById("addMultiAssign");
                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = "報修單 批量派工";
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("DueDate").value = "";
                    $('#addMultiAssign #RepairUserName').tagbox('clear');
                }, { once: true })
            } else {
                createDialogModal({
                    id: "DialogModal-Error", inner: `請先勾選欲派工的報修單！`,
                })
                return;
            }
        });

        //點擊 匯出btn
        $("#export").click(function () {
            const fd = new FormData();
            for (const [key, value] of Object.entries(getQueryParams('#form'))) {
                fd.append(key, value);
            }
            ajaxExport({
                url: "@Url.Action("ExportToExcel")",
                data: fd,
                name: `報修單.xlsx`
            })
        })

        //search area onClick Function
        function addSearchAreaClickEvent() {
            $("#search").click(function () {
                DataGrid.datagrid('load', getQueryParams());
            });

            $("#create").click(function () {
                window.open(`${baseUrl}/Create`, "_self");
            });
        }

        //取得被勾選的報修單號
        function getCheckedRSN() {
            const checkedRows = $('#DataGrid').datagrid('getChecked');
            const rsnList = checkedRows.map(row => row.RSN);
            return rsnList;
        }

        //判斷是否全選，全選的話將header checkbox勾選
        function checkIfAllChecked(data) {
            //計算可選取(非禁用)的列數 和 實際被選取的數量
            var selectableCount = 0;
            var selectedCount = 0;
            for (var j = 0; j < data.rows.length; j++) {
                if (data.rows[j].ReportState === "待派工") {
                    selectableCount++;
                    // 判斷此列是否已被選取
                    if (checkedArray.indexOf(data.rows[j].RSN) !== -1) {
                        selectedCount++;
                    }
                }
            }

            var panel = $('#DataGrid').datagrid('getPanel');
            if (selectableCount > 0 && selectedCount === selectableCount) {
                panel.find('.datagrid-header-check input[type="checkbox"]').prop('checked', true);
            } else {
                panel.find('.datagrid-header-check input[type="checkbox"]').prop('checked', false);
            }
        }

        function save() {
            const repairUserNameValue = $('#addMultiAssign #RepairUserName').tagbox('getValues');
            if (!repairUserNameValue?.length) {
                alert('請選擇執行人員');
                return false;
            }
            let isValidity = $('#addMultiAssign form')[0].reportValidity()
            console.log("isValidity():", isValidity);

            if (!isValidity) return;

            let d = document.getElementById("DueDate").value;
            let datePattern = /^(\d{3})([\/-]\d{2}[\/-]\d{2})$/;
            if (datePattern.test(d)) {
                d = d.replace(datePattern, (_, year, rest) => `${parseInt(year) + 1911}${rest}`);
            }

            const sendData = {
                RSN: checkedArray,
                DueDate: d,
                RepairUserName: $('#addMultiAssign #RepairUserName').tagbox('getValues'),
            }
            console.log("傳送的資料", sendData);


            $.ajax({
                url: "@Url.Action("Assignment", "Repair_Management")",
                data: JSON.stringify(sendData),
                type: "POST",
                contentType: "application/json",
                processData: false,
                success: onSuccess,
                error: onError
            })
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addMultiAssign'));

            function onSuccess(res) {
                modal.hide();
                console.log(res);
                createDialogModal({
                    id: "DialogModal-Success", inner: "派工成功！",
                    onHide: () => { window.location.href = "/Repair_Management/Index"; }
                });
            }
            function onError(res) {
                modal.hide();
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `派工失敗！` + `${res?.responseText || ""}` })
            }
        }


    </script>
}
