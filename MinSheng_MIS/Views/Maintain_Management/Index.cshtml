@{
    ViewBag.Title = "定期保養管理";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <script src="/Scripts/Repair_Management/Index.js" defer></script>
    <link rel="stylesheet" href="/Content/tagbox.css">
}

<h2>@ViewBag.Title</h2>

<div class="dg-tool-bar">
    <div class="search-area">
        <form class="form" method="post" action="" id="form">
            <div class="form-group">
                <label for="Status">保養單狀態</label>
                <select class="form-select" name="Status" id="Status"></select>
            </div>

            <div class="form-group">
                <label for="EMFSN">保養單號</label>
                <input class="form-control" id="EMFSN" name="EMFSN" type="text" />
            </div>

            <div class="form-group">
                <label for="NextMaintainDateFrom">最近應保養日期(起)</label>
                <input class="form-control" id="NextMaintainDateFrom" name="NextMaintainDateFrom" type="date" />
            </div>

            <div class="form-group">
                <label for="NextMaintainDateTo">最近應保養日期(迄)</label>
                <input class="form-control" id="NextMaintainDateTo" name="NextMaintainDateTo" type="date" />
            </div>

            <div class="form-group">
                <label for="ReportTimeFrom">實際保養日期(起)</label>
                <input class="form-control" id="ReportTimeFrom" name="ReportTimeFrom" type="date" />
            </div>

            <div class="form-group">
                <label for="ReportTimeTo">實際保養日期(迄)</label>
                <input class="form-control" id="ReportTimeTo" name="ReportTimeTo" type="date" />
            </div>
            <div class="form-group">
                <label for="EState">設備狀態</label>
                <select class="form-select" name="EState" id="EState"></select>
            </div>

            <div class="form-group">
                <label for="ASN">棟別</label>
                <select class="form-select" name="ASN" id="ASN"></select>
            </div>

            <div class="form-group">
                <label for="FSN">樓層</label>
                <select class="form-select" name="FSN" id="FSN"></select>
            </div>

            <div class="form-group">
                <label for="EName">設備名稱</label>
                <input class="form-control" id="EName" name="EName" type="text" />
            </div>

            <div class="form-group">
                <label for="ESN">設備編號</label>
                <input class="form-control" id="ESN" name="ESN" type="text" />
            </div>

            <div class="form-group">
                <label for="MaintainName">保養項目</label>
                <input class="form-control" id="MaintainName" name="MaintainName" type="text" />
            </div>

            <div class="form-group">
                <label for="Period">保養週期</label>
                <select type="text" class="form-select" name="Period" id="Period"></select>
            </div>

            <div class="form-group">
                <label for="Member">執行人員</label>
                <select type="text" class="form-select" name="Member" id="Member"></select>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-search" id="search">查詢</button>
                <button type="reset" class="btn btn-clear" id="clear">清除</button>
                <button type="button" class="btn btn-export" id="export">匯出</button>
            </div>

        </form>
    </div>
    <button type="button" class="btn btn-other" id="multiAssign">批量派工</button>
    @*<button type="button" class="btn btn-other" id="multiAssign" data-bs-toggle="modal" data-bs-target="#addMultiAssign" data-title="定期保養單 批量派工">批量派工</button>*@
    <div class="datagrid-area">
        <table id="DataGrid"></table>
    </div>
</div>


@*派工POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="addMultiAssign">
    <div class="modal-dialog modal-screen-md modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>報修單 派工</h2>
                <form class="form w-100 p-0">
                    <div class="form-group-zone">
                        <div class="form-group col-3fr required">
                            <label for="NextMaintainDate">預計保養日期</label>
                            <input type="date" class="form-control" name="NextMaintainDate" id="NextMaintainDate" maxlength="20" required>
                        </div>
                        <div class="form-group col-3fr required">
                            <label for="Maintainer">執行人員</label>
                            <select type="text" class="form-select repair-user-name" name="Maintainer" id="Maintainer"></select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="submit">確定</button>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        var getGridJSON = '@Url.Action("MaintainForm_Management", "Datagrid")';
        var DataGrid;
        let currentEMFSN = "";

        const fakedata = [
            {
                Status: "待派工",
                EMFSN: "P23010401",
                NextMaintainDate: '2023-01-03',
                ReportTime: "2023-01-04",
                EState: "正常",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                ESN: "32369304",
                MaintainName: "皮帶之保養",
                Period: "每月",
                Maintainer: "王大明、李泰順",
            },
            {
                Status: "待執行",
                EMFSN: "P23010402",
                NextMaintainDate: '2023-01-04',
                ReportTime: "2023-01-04",
                EState: "正常",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                ESN: "32369304",
                MaintainName: "皮帶之保養",
                Period: "每月",
                Maintainer: "王大明、李泰順",
            },
            {
                Status: "待審核",
                EMFSN: "P23010403",
                NextMaintainDate: '2023-01-04',
                ReportTime: "2023-01-04",
                EState: "正常",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                ESN: "32369304",
                MaintainName: "皮帶之保養",
                Period: "每月",
                Maintainer: "王大明、李泰順",
            },
            {
                Status: "審核通過",
                EMFSN: "P23010404",
                NextMaintainDate: '2023-01-04',
                ReportTime: "2023-01-04",
                EState: "正常",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                ESN: "32369304",
                MaintainName: "皮帶之保養",
                Period: "每月",
                Maintainer: "王大明、李泰順",
            },
            {
                Status: "審核未過",
                EMFSN: "P23010405",
                NextMaintainDate: '2023-01-04',
                ReportTime: "2023-01-04",
                EState: "正常",
                ASN: "進流抽水站",
                FSN: "B2F",
                EName: "生物反應池菌種選擇區攪拌機",
                ESN: "32369304",
                MaintainName: "皮帶之保養",
                Period: "每月",
                Maintainer: "王大明、李泰順",
            },
        ]
        let authority ;
        $(async function () {
            //取得權限
            (async () => {
                try {
                    authority = await checkAuthority('@Url.Action("UserAuthority", "Account")');
                    console.log("權限", authority);
                } catch (error) {
                    console.error("權限回傳失敗", error);
                }
            })();
            await formDropdown.ASN()
            await pushSelect("Status", '@Url.Action("MaintainStatus", "DropDownList")');
            await pushSelect("EState", '@Url.Action("EState", "DropDownList")');
            await pushSelect("Period", '@Url.Action("MaintainPeriod", "DropDownList")');
            await pushSelect("Member", '@Url.Action("MaintainUserName", "DropDownList")');
            await addDropDownList();
            await addButtonEvent();
            Initialize_DataGrid(getGridJSON, authority);
            addSearchAreaClickEvent();
            if (authority === "3") {
                document.getElementById('multiAssign').classList.add('d-none');
            }
        });

        function Initialize_DataGrid(getGridJSON, authority) {
            console.log("authority", authority);
            let dg = new DG();
            DataGrid = dg.init("#DataGrid", {
                url: getGridJSON,
                //data: fakedata,
                method: 'POST',
                queryParams: getQueryParams(),
                idField: 'EMFSN',
                singleSelect: false,
                frozenColumns: [[
                    { field: 'ck', checkbox: true }, // 新增 checkbox
                    dg.frozenColumn('_detail', (v, row, i) => dg.eventButton(i, "詳情", "detail")),
                    dg.frozenColumn('_review', (v, row, i) => dg.eventButton(i, "審核", "review", { disabled: row.Status != "待審核" || authority != "1"})),
                    dg.frozenColumn('_assign', (v, row, i) => dg.eventButton(i, "派工", "assign", { disabled: row.Status != "待派工" || authority === "3", className: "btn btn-datagrid btn-other", dataTitle: "定期保養單 派工" })),
                ]],
                onLoadSuccess: function (data) {
                    const rows = data.rows;
                    rows.forEach((row, index) => {
                        if (row.Status !== "待派工") {
                            const checkbox = $('#DataGrid').datagrid('getPanel').find(`#DataGrid_datagrid-row-r1-1-${index} input[type="checkbox"]`);
                            checkbox.prop('disabled', true);
                        }
                    });
                },
                columns: [[
                    dg.column('Status', '保養單狀態', 150),
                    dg.column('EMFSN', '保養單號', 150),
                    dg.column('NextMaintainDate', '最近應保養日期', 180),
                    dg.column('ReportTime', '實際保養時間', 160),
                    dg.column('EState', '設備狀態', 150),
                    dg.column('Area', '棟別', 200),
                    dg.column('FloorName', '樓層', 200),
                    dg.column('EName', '設備名稱', 300),
                    dg.column('ESN', '設備編號', 150),
                    dg.column('MaintainName', '保養項目', 200),
                    dg.column('Period', '保養週期', 150),
                    dg.column('Maintainer', '執行人員', 300),
                ]]
            })
            dg.addEvent("detail", function (row, i) {
                window.open(`${baseUrl}/Detail?EMFSN=${row.EMFSN}`, "_blank")
            })
            dg.addEvent("review", function (row, i) {
                window.open(`${baseUrl}/Review?EMFSN=${row.EMFSN}`, "_self")
            })
            dg.addEvent("assign", function (row, i) {
                currentEMFSN = row.EMFSN;
                const modal = document.getElementById("addMultiAssign");

                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = `定期保養單 派工`;
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("NextMaintainDate").value = "";
                    $('#addMultiAssign #Maintainer').tagbox('clear');

                    document.getElementById("multiAssign").focus();
                }, { once: true })
            });
        }

        //點擊 批量派工btn
        document.getElementById("multiAssign").addEventListener("click", function () {
            currentEMFSN = getCheckedEMFSN();
            if (currentEMFSN.length > 0) {
                const modal = document.getElementById("addMultiAssign");
                const modalTitle = modal.querySelector('#addMultiAssign h2');
                if (modalTitle) {
                    modalTitle.textContent = "定期保養單 批量派工";
                }
                $(modal).modal("show");

                // 關閉modal時清空modal
                modal.addEventListener('hidden.bs.modal', () => {
                    document.getElementById("NextMaintainDate").value = "";
                    $('#addMultiAssign #Maintainer').tagbox('clear');
                }, { once: true })
            } else {
                createDialogModal({
                    id: "DialogModal-Error", inner: `請先勾選欲派工的保養單！`,
                })
                return;
            }
        });

        //點擊 匯出btn
        $("#export").click(function () {
            const fd = new FormData();
            for (const [key, value] of Object.entries(getQueryParams('#form'))) {
                fd.append(key, value);
            }
            $.ajax({
                url: "@Url.Action("ExportToExcel", "Maintain_Management")",
                data: fd,
                type: "POST",
                contentType: false,
                processData: false,
                success: onSuccess,
                error: onError,
                xhrFields: {
                    responseType: 'blob'  //指定響應類型為blob
                },
            })
            function onSuccess(res) {
                console.log("onSuccess res:", res);
                let a = document.createElement('a');
                let url = window.URL.createObjectURL(res);
                a.href = url;
                a.download = `定期保養單.xlsx`;
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `匯出失敗！` + `${res?.responseText || ""}` })
            }
        })

        //search area onClick Function
        function addSearchAreaClickEvent() {
            $("#search").click(function () {
                DataGrid.datagrid('load', getQueryParams());
            });
        }

        //取得被勾選的報修單號
        function getCheckedEMFSN() {
            const checkedRows = $('#DataGrid').datagrid('getChecked');
            const emfsnList = checkedRows.map(row => row.EMFSN);
            return emfsnList;
        }

        function save() {
            const maintainerValue = $('#addMultiAssign #Maintainer').tagbox('getValues');
            if (!maintainerValue?.length) {
                alert('請選擇執行人員');
                return false;
            }
            let isValidity = $('#addMultiAssign form')[0].reportValidity()
            console.log("isValidity():", isValidity);

            if (!isValidity) return;

            const sendData = {
                EMFSN: currentEMFSN,
                NextMaintainDate: document.getElementById("NextMaintainDate").value,
                Maintainer: $('#addMultiAssign #Maintainer').tagbox('getValues'),
            }
            console.log("傳送的資料", sendData);


            $.ajax({
                url: "@Url.Action("Assignment", "Maintain_Management")",
                data: JSON.stringify(sendData),
                type: "POST",
                contentType: "application/json",
                processData: false,
                success: onSuccess,
                error: onError
            })
            const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('addMultiAssign'));

            function onSuccess(res) {
                modal.hide();
                console.log(res);
                createDialogModal({
                    id: "DialogModal-Success", inner: "派工成功！",
                    onHide: () => { window.location.href = "/Maintain_Management/Index"; }
                });
            }
            function onError(res) {
                modal.hide();
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `派工失敗！` + `${res?.responseText || ""}` })
            }
        }
    </script>
}
