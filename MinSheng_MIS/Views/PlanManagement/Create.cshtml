@{
    ViewBag.Title = "新增 工單";
}
@section styles {
    @Html.Partial("DataGridScripts")
    <script src="~/Scripts/PlanManagement/CreateDataGrids.js" defer></script>
    <script src="~/Scripts/PlanManagement/Create.js"></script>
    <script src="~/Scripts/Sortable.min.js"></script>
    <link rel="stylesheet" href="/Content/tagbox.css">
}


<h2>@ViewBag.Title</h2>

<section>
    <div class="edit-area edit-area-full flex-lg-row">
        <form class="form justify-content-lg-end">
            <div class="form-group-zone">
                <div class="form-group required">
                    <label for="IPName">工單名稱</label>
                    <input type="text" class="form-control" name="IPName" id="IPName" maxlength="20" required>
                </div>
                <div class="form-group required">
                    <label for="PlanDate">工單日期</label>
                    <input type="date" class="form-control" name="PlanDate" id="PlanDate" required>
                </div>
            </div>
            <hr class="hr-default" />

            <div class="datatable-easyui w-100 d-none">
                <table id="Template-datagrid"></table>
            </div>
            <button type="button" class="btn btn-search align-self-start" id="create-item" data-bs-toggle="modal" data-bs-target="#AutoLink">+ 自動代入每日巡檢模板</button>

            <div class="m-0 w-100 text-center">
                <div class="datatable datatable-grid w-100 h-100">
                    <div class="datatable-body h-100 overflow-auto">
                        <table class="datatable-table">
                            <thead>
                                <tr>
                                    <th class="datatable-header" style="width:40px"><span></span></th>
                                    <th class="datatable-header" style="width:40px"><span></span></th>
                                    <th class="datatable-header required" style="width:130px"><span>巡檢時間(起)</span></th>
                                    <th class="datatable-header required" style="width:130px"><span>巡檢時間(迄)</span></th>
                                    <th class="datatable-header required" style="width:250px"><span>巡檢路線名稱</span></th>
                                    <th class="datatable-header required" style="width:120px"><span>巡檢數量</span></th>
                                    <th class="datatable-header required" style="width:120px"><span>巡檢頻率</span></th>
                                    <th class="datatable-header" style="width:150px"><span></span></th>
                                    <th class="datatable-header required" style="width:325px"><span>執行人員</span></th>
                                    <th class="datatable-header" style="width:36px"></th>
                                </tr>
                            </thead>
                            <tbody id="item-area">
                                <tr id="sample-input-tr">
                                    <td id="d-Num">1</td>
                                    <td id="d-Sort">
                                        <button type="button" class="btn-sort">
                                            <i class="fa-solid fa-bars"></i>
                                        </button>
                                    </td>
                                    <td>
                                        <input class="form-control" type="time" id="StartTime" name="StartTime" step="any" required />
                                    </td>
                                    <td>
                                        <input class="form-control" type="time" id="EndTime" name="EndTime" step="any" required />
                                    </td>
                                    <td>
                                        <select class="form-select" id="PlanPathSN" name="PlanPathSN" required></select>
                                    </td>
                                    <td id="Quantity">--</td>
                                    <td id="Frequency">--</td>
                                    <td id="Info">
                                        <button type="button" class="btn btn-datagrid">巡檢路線資訊</button>
                                    </td>
                                    <td>
                                        <select class="form-select operator-name" id="UserID" name="UserID" required></select>
                                    </td>
                                    <td id="d-_delete" class="p-1 pt-2">
                                        <button type="button" class="btn-delete-item"></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <button type="button" class="addItemBtn" id="addItem"><i class="fa-solid fa-plus"></i></button>
            </div>
        </form>
    </div>
</section>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">新增</button>
</div>

@*巡檢路線資訊POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="PlanInfo">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content height-fit">
            <div class="modal-body align-items-center">
                <h2>巡檢路線資訊</h2>
                <div class="datatable datatable-small">
                    <div class="datatable-body">
                        <table class="datatable-table" id="PathDetail"></table>
                    </div>
                </div>
                <div class="datatable datatable-grid datatable-fill">
                    <div class="datatable-body overflow-auto">
                        <table class="datatable-table" id="EInfo">
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-export" data-bs-dismiss="modal">確定</button>
            </div>
        </div>
    </div>
</div>

@*每日巡檢時程模板POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="AutoLink">
    <div class="modal-dialog modal-fullscreen modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h2>每日巡檢時程模板</h2>
                <div class="search-area">
                    <form class="form">
                        <div class="form-group">
                            <label for="TemplateName">巡檢路線名稱</label>
                            <input class="form-control" id="TemplateName" name="TemplateName" type="text" />
                        </div>
                        <div class="button-group">
                            <button type="button" class="btn btn-search" id="search">查詢</button>
                            <button type="reset" class="btn btn-clear" id="clear">清除</button>
                        </div>
                    </form>
                </div>
                <table class="modal-datagrid"></table>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">返回</button>
                <button type="button" class="btn btn-export" id="add-row">確定</button>
            </div>
        </div>
    </div>
</div>


@section scripts {
    <script>
        let pathApiUrl = '@Url.Action("ReadBody", "SamplePath_Management")';
        let templateApiUrl = '@Url.Action("ReadBody", "SampleSchedule_Management")';
        let SubmitUrl = '@Url.Action("CreateInspectionPlan", "PlanManagement")';
        let sampleTr = SampleTr();
        let sortableController = null;

        $(async function () {
            addButtonEvent();
            await pushSelect("PlanPathSN", "/DropDownList/InspectionPathSample");
            autoLinkDG_Controller = new PIDG(ALDGOptions);
            sampleTr.init();
            sampleTr.create();
            setSortableItem("#item-area");
        })

        const SerializedName = [
            { text: "巡檢路線名稱", value: "PathName" },
        ]
        const GridOptions = {
            thead: true,
            columns: [
                { id: "Index", title: "" },
                { id: "InternalCode", title: "RFID內碼" },
                { id: "ExternalCode", title: "RFID外碼" },
                { id: "RFIDName", title: "RFID名稱" },
                { id: "RFIDArea", title: "RFID棟別" },
                { id: "RFIDFloor", title: "RFID樓層" },
                { id: "RFIDMemo", title: "RFID備註" },
                { id: "EName", title: "設備名稱" },
                { id: "NO", title: "設備編號" },
                { id: "Brand", title: "廠牌" },
                { id: "Model", title: "型號" },
                { id: "Frequency", title: "巡檢頻率" },
            ]
        }
        fakeData = {
            PathNameSN: "1120301001",
            PathName: "前處理機房巡檢",
            Frequency: "3",
            Equipments: [
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName1",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機1",
                    ESN: "SP-0202A",
                    Brand: "A廠牌",
                    Model: "XMA-56",
                    Frequency: "3",
                },
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName2",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機2",
                    ESN: "SP-0202A",
                    Brand: "B廠牌",
                    Model: "XMA-56",
                    Frequency: "2",
                },
                {
                    InterCode: "XSCXCZS",
                    ExterCode: "XSCXCZS",
                    RFIDName: "RFIDName3",
                    Area: "前處理區",
                    Floor: "1F",
                    Memo: "備註",
                    EName: "螺旋發送機3",
                    ESN: "SP-0202A",
                    Brand: "C廠牌",
                    Model: "XMA-56",
                    Frequency: "2",
                },
            ]
        }
        let pathData = {};

        const setSortableItem = (containerSelector, options = null) => {
            let defaultOptions = {
                animation: 150,
                handle: '.btn-sort',
                onEnd: () => {
                    reorderNumbers();
                }
            }
            const element = document.querySelector(containerSelector);
            if (!element) {
                console.warn('not found sortable container target!');
                return
            }
            if (options) Object.assign(defaultOptions, options);
            sortableController = Sortable.create(element, defaultOptions)
        }
        const updateTemplateWithSN = async (SN) => {
            let templateData = await readData(templateApiUrl, SN);
            let allPathSN = templateData.Contents.map(e => e.PlanPathSN);
            console.log('allPathSN', allPathSN);
            sampleTr.list.empty();
            sampleTr.count = 0;
            templateData.Contents.forEach(c => {
                sampleTr.create(c);
            })
        }
        const updatePathDetail = async (SN) => {
            if (!pathData[SN]) pathData[SN] = await readData(pathApiUrl, SN);
            // 在每列加上index
            function createIndexToArrayData(arr) {
                return arr.map((e, i) => {
                    return {
                        Index: i + 1,
                        ...e
                    }
                })
            }
            $("#PathDetail").empty();
            $("#PathDetail").append(createTableInner(pathData[SN], SerializedName));
            $("#EInfo").empty();
            pathData[SN].Equipments ?
                $("#EInfo").append(createTableGrid(
                    createIndexToArrayData(pathData[SN].Equipments), GridOptions)) :
                $("#EInfo").parents(".datatable").remove();
        }
        const updateTemplateInfo = async (SN, element) => {
            if (SN) {
                if (!pathData[SN]) pathData[SN] = await readData(pathApiUrl, SN)
                $(element).parent().parent().find("#Quantity").text(pathData[SN].Equipments?.length || "--");
                $(element).parent().parent().find("#Frequency").text(pathData[SN].Frequency);
            } else {
                $(element).parent().parent().find("#Quantity").text("--");
                $(element).parent().parent().find("#Frequency").text("--");
            }
        }
        function readData(url = null, SN) {
            return new Promise((resolve, reject) => {
                $.ajax({
                    url: `${url}?id=${SN}`,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: (res) => {
                        resolve(onSuccess(res));
                    },
                    error: (ex) => {
                        onError(ex);
                        reject(ex);
                    }
                });
            });

            function onSuccess(res) {
                res = res.Datas
                const convertString = (v) => `每${v}小時`
                res.Frequency = convertString(res.Frequency);
                console.log("getPathDetail(after converting)", res);
                return res
            }
            function onError(ex) {
                console.error(ex);
            }
        }
        function save(data) {
            if (!data) return;
            $.ajax({
                url: SubmitUrl,
                data: JSON.stringify(data),
                type: "POST",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

            function onSuccess(res) {
                console.log(res);
                if (!res.ErrorMessage) {
                    createDialogModal({
                        id: "DialogModal-Success", inner: "新增成功！",
                        onHide: () => { window.location.href = "/PlanManagement/Index"; }
                    });
                } else {
                    createDialogModal({ id: "DialogModal-Error", inner: `新增失敗！` + `${res?.ErrorMessage || ""}` })
                }
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `新增失敗！` })
            }
        }

        function SampleTr() {
            this.count = 0;
            this.list = $("#item-area")
            this.init = async function () {
                const observer = new ResizeObserver((entries) => {
                    for (const entry of entries) {
                        let style = getComputedStyle(entry.target)
                        let mh = parseInt(style.getPropertyValue("max-height").match(/(\d)+/)?.[0])
                        let h = parseInt(style.getPropertyValue("height").match(/(\d)+/)?.[0])
                        $(".datatable-input-area").toggleClass("max-w-scroll", h >= mh)
                        //console.log(`${h} >= ${mh} ${h >= mh}`)
                    }
                })
                observer.observe(this.list.closest(".datatable-body")[0])

                this.list.on("click", ".btn-delete-item", function (e) {
                    $(this).parent().parent().remove();
                    sampleTr.count--;
                    reorderNumbers();
                })
                this.list.on("click", ".btn-datagrid", function (e) {
                    let SN = $(this).parent().parent().find("#PlanPathSN").val();
                    if (!SN) {
                        createDialogModal({ id: "DialogModal", inner: "請先選擇巡檢路線", button: [{ className: "btn btn-export", cancel: true, text: "確定" }] })
                        return
                    }
                    updatePathDetail(SN);
                    let b = document.createElement("button");
                    b.type = "button";
                    b.setAttribute("data-bs-toggle", "modal");
                    b.setAttribute("data-bs-target", "#PlanInfo");
                    document.querySelector("body").appendChild(b);
                    b.click();
                    b.remove();
                })
                this.list.on("change", "#PlanPathSN", function (e) {
                    let SN = $(this).val();
                    //console.log(SN);
                    updateTemplateInfo(SN, this);
                })
                this.sample = $("#sample-input-tr").clone();
                $("#sample-input-tr").remove();
            }
            this.create = function (data = null) {
                let item = this.sample.clone();
                this.count++;
                item.attr('id', this.count);
                item.find("#Info button").attr("index", this.count);
                item.find("#d-Num").text(this.count)
                item.find(`#UserID`).attr("id", "UserID" + this.count);
                if (data) {
                    item.find("#PlanPathSN").val(data.PlanPathSN);
                    item.find("#StartTime").val(data.StartTime);
                    item.find("#EndTime").val(data.EndTime);
                    item.find("#Quantity").text(data.EquipmentCount);
                    item.find("#Frequency").text(data.Frequency);
                }
                this.list.append(item);
                addDropDownList("#UserID" + this.count);
            }
            this.calc = function () {
                return this.list.children().toArray().map((e) => {
                    return {
                        StartTime: $(e).find("#StartTime").val(),
                        EndTime: $(e).find("#EndTime").val(),
                        PlanPathSN: $(e).find("#PlanPathSN").val(),
                        Executors: $(e).find(".operator-name").tagbox('getValues')
                    }
                })
            }
            this.checkValidity = () => {
                let Equipments = this.list.children().toArray().map((e) => ({
                    StartTime: $(e).find("#StartTime").val(),
                    EndTime: $(e).find("#EndTime").val(),
                    PlanPathSN: $(e).find("#PlanPathSN").val(),
                    Executors: $(e).find(".operator-name").tagbox('getValues')
                }))
                for (item of Equipments) {
                    if (!item.StartTime || !item.EndTime || !item.PlanPathSN || item.Executors.length == 0) return false
                }
                return true
            }
            this.checkRequired = () => {
                return this.list.children().length > 0
            }
            this.checkDuplicate = () => {
                let sisns = this.list.children().toArray().map((e) => {
                    return $(e).find("#StockName").val()
                }).filter(e => e || void 0)
                let sets = new Set([...sisns])
                return sisns.length == [...sets].length
            }
            return this;
        }

        //當刪除新增的模板後，需重新排序次序
        function reorderNumbers() {
            let itemArea = document.getElementById('item-area');
            let rows = itemArea.querySelectorAll('tr');
            rows.forEach((row, index) => {
                let numCell = row.querySelector('#d-Num');
                if (numCell) {
                    numCell.textContent = index + 1;
                }
            });
        }
    </script>
}