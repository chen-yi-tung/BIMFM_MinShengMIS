@{
    ViewBag.Title = "編輯月報";
}
@section styles {
    <script src="/Scripts/datatable.js" defer></script>
    <script src="/Scripts/tool.js" defer></script>
    <style>
        @@media (min-width: 992px) {
            .edit-area .form {
                grid-template-columns: 250px 250px;
            }
        }
    </style>
}

<h2>@ViewBag.Title</h2>

<section>
    <div class="edit-area edit-area-sm flex-lg-row">
        <form class="form">
            <div class="form-group-zone">
                <input type="text" name="MRSN" id="MRSN" hidden>
                <div class="form-group required">
                    <label for="ReportTitle">月報名稱</label>
                    <input class="form-control" id="ReportTitle" name="ReportTitle" type="text" required>
                </div>

                <div class="form-group required">
                    <label for="YearMonth">年月份</label>
                    <div style="display: flex; gap: 8px;">
                        <select class="yearSelect form-select" id="Year"></select>
                        <select class="monthSelect form-select" id="Month"></select>
                    </div>
                </div>

                <div class="form-group" style="grid-column: auto/span 2;">
                    <label for="ReportContent">內容說明</label>
                    <textarea class="form-control" name="ReportContent" id="ReportContent" rows="3" maxlength="200"></textarea>
                </div>

                <div id="FileUploader"></div>
            </div>
        </form>
    </div>
</section>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-export" id="submit">儲存</button>
</div>

    @section scripts {
        <script>
        const MRSN = '@ViewBag.id';
        const apiUrl = '@Url.Action("ReadBody", "MonthlyReport_Management")' + `/${MRSN}`;
        const fakeData = {
            MRSN: "1",
            ReportTitle: "2023-5月月報",
            UploadUserName: "王大明",
            UploadDateTime: "2023/5/22",
            ReportContent: "OOXX",
            YearMonth: "2023-05",
            FilePath: "/Files/a.pdf"
        }
        var fileUploader
        $(async function () {
            addButtonEvent();
            fileUploader = new FileUploader({
                container: "#FileUploader",
                className: "form-group g-col-2 required",
                label: "月報檔案",
                id: "File",
                customValidity: true
            })
            readData(apiUrl);
        });
        $(document).ready(function () {
            createYearMonthSelect();
        });

        function readData(url = null) {
            url == null ? onSuccess(fakeData) :   //res
                $.ajax({
                    url: url,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

            function onSuccess(res) {
                console.log(res);
                for (let [k, v] of Object.entries(res)) {
                    if (k === "YearMonth") {
                        const [ADYear, month] = v.split('-');
                        document.getElementById('Year').value = parseInt(ADYear) - 1911;
                        document.getElementById('Month').value = parseInt(month);
                    }
                    $("#" + k).val(v);
                }
                fileUploader.setFile(res.FilePath)
            }
            function onError(res) {
                console.log(res);
            }
        }

        function save() {
            //重置自訂驗證錯誤訊息
            getAllParams().forEach((e) => {
                e.setCustomValidity('');
            })
            //自訂驗證錯誤
            fileUploader.setExtensionValidity(fileUploader.checkAllExtension())
            let isValidity = [...document.forms].map(e => e.reportValidity()).every(e => e);
            console.log("isValidity():", isValidity)
            if (!isValidity) return;

            var fd = new FormData();
            fd.append("MRSN", '@ViewBag.id');
            fd.append("ReportTitle", document.getElementById("ReportTitle").value);
            fd.append("ReportContent", document.getElementById("ReportContent").value);
            const YearMonthValue = (parseInt(document.getElementById("Year").value) + 1911) + "-" + String(document.getElementById("Month").value).padStart(2, '0');
            fd.append("YearMonth", YearMonthValue);
            if (fileUploader.hasFile()) {
                let file = fileUploader.getFile()
                if (file.size) {
                    fd.append("ReportFile", file);
                }
                else {
                    fd.append("ReportFileStr", file.name);
                }
            }
            console.log(fileUploader.getFile())
            console.log(Object.fromEntries(fd.entries()));
            $.ajax({
                url: '@Url.Action("EditMonthlyReport", "MonthlyReport_Management")',
                data: fd,
                type: "POST",
                contentType: false,
                processData: false,
                success: onSuccess,
                error: onError
            })
            function onSuccess(res) {
                console.log(res);
                if (res.success == false) {
                    createDialogModal({ id: "DialogModal-Error", inner: `儲存失敗！` + `${res?.responseText || ""}` })
                }
                else {
                    createDialogModal({
                        id: "DialogModal-Success", inner: "儲存成功！",
                        onHide: () => { window.location.href = "/MonthlyReport_Management/Index"; }
                    });
                }
            }
            function onError(res) {
                console.log(res);
                createDialogModal({ id: "DialogModal-Error", inner: `儲存失敗！` + `${res?.responseText || ""}` })
            }
        }

        function addButtonEvent() {
            $("#back").click(function () {
                history.back();
            })

            $("#submit").click(function () {
                save();
            })
        }
        function createYearMonthSelect() {
            generateYearSelect("Year");
            generateMonthSelect("Month");
        }
        </script>
    }
