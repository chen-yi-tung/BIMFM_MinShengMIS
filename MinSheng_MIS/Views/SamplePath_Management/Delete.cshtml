@{
    ViewBag.Title = "巡檢路線模板刪除";
}
<link rel="stylesheet" href="/Content/samplepath.css">

<h2>@ViewBag.Title</h2>

<input type="text" id="PSSN" name="PSSN" hidden>

<div class="datatable datatable-small mt-5">
    <div class="datatable-body">
        <table class="datatable-table" id="PathSampleInfo"></table>
    </div>
</div>

<div class="sample-path-area">
    <h3 class="sample-path-title">巡檢路線規劃</h3>

    <div class="edit-area">
        <div class="sample-path-group-area">
            <div class="input-group sample-path-group" data-path-id="1">
                <span class="input-group-text" id="current-path-title"></span>
                <div type="text" class="form-control">
                    <nav>
                        <ol class="breadcrumb" id="current-path-display"></ol>
                    </nav>
                </div>
            </div>
        </div>
        <div class="sample-path-draw-area">
            <input type="number" id="current-path-id" value="1" hidden>
            <div class="viewer3Dcontainer">
                <div id="viewer3d" style="margin:0;"></div>
                <canvas id="PathCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-delete" id="delete">刪除</button>
</div>

<!-- Autodesk Forge -->
<link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/style.min.css?v=v7.4"
    type="text/css">
<script language="JavaScript"
    src="https://developer.api.autodesk.com/modelderivative/v2/viewers/viewer3D.min.js?v=v7.4"></script>
<script language="JavaScript" src="/Scripts/Forge/UpViewer.js"></script>

<!-- PIXI Draw -->
<script src="https://pixijs.download/v7.2.2/pixi.js"></script>
<script src="/Scripts/ForgeDraw.js"></script>
<script src="/Scripts/datatable.js"></script>
<script src="/Scripts/Forge/ForgeDrawFunction.js"></script>
<script src="/Scripts/Forge/SamplePathReadOnly.js"></script>

<!-- EVENT -->
<script src="../../Scripts/tool.js"></script>
<script>
    const PSSN = '@ViewBag.PSSN';
    let apiUrl = '@Url.Action("ReadBody", "SamplePath_Management")' + `/${PSSN}`;

    let fakeData;

    $(async function () {
        addButtonEvent();
        readData(apiUrl);
    });

    function readData(url = null) {

        url == null ? onSuccess(fakeData) :
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

        async function onSuccess(res) {
            console.log(res);
            fakeData = res;
            let ps = res.PathSample;

            $("#PSSN").val(ps.PSSN);

            $("#PathSampleInfo").append(
                createTableInner(ps, [
                    { text: "巡檢路線模板", value: "PathTitle" },
                    { text: "棟別", value: "Area" },
                    { text: "樓層", value: "Floor" },
                ])
            )

            $("#current-path-title").text(ps.PathTitle);

            viewerUrl = window.location.origin + ps.BIMPath;
            initializeViewer(initializeDrawer);
        }
        function onError(res) {
            console.log(res);
        }
    }

    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        });
        $("#delete").click(function () {
            let modal = createDialogModal({
                id: "DialogModal-Delete",
                inner: `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                        class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
                        <path
                            d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z" />
                    </svg>
                    確認是否刪除？
                `,
                button: [
                    { className: "btn btn-cancel", cancel: true, text: "取消", },
                    { className: "btn btn-delete", text: "確定刪除", onClick: onDelete },
                ]
            })

            function onDelete(e) {
                let PSSN = $("#PSSN").val();
                console.log(PSSN);
                let spinner = ` <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
                $(this).append(spinner);

                $.ajax({
                    url: '@Url.Action("DeleteSamplePath", "SamplePath_Management")?PSSN=' + PSSN,
                    data: JSON.stringify(PSSN),
                    type: "POST",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })


                function onSuccess(res) {
                    console.log(res);
                    modal.hide();
                    createDialogModal({
                        id: "DialogModal-Success",
                        inner: "刪除成功！",
                        onHide: () => {
                            let url = '@Url.Action("Management", "SamplePath_Management")';
                            window.location.href = url;
                        }
                    })
                }

                function onError(res) {
                    console.log(res);
                    modal.hide();

                    createDialogModal({ id: "DialogModal-Error", inner: "刪除失敗！" })
                }
            }
        });
    }
</script>