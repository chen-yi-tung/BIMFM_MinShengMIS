@{
    ViewBag.Title = "巡檢路線模板 詳情";
}
@section styles {
    @Styles.Render("https://developer.api.autodesk.com/modelderivative/v2/viewers/style.min.css")
    @Styles.Render("~/Content/loading.css")
    @Styles.Render("~/Content/bim.css")
    @Html.Partial("DataGridScripts")
    <script src="/Scripts/dataTable/InspectionPlanRepair.js" defer></script>
    <script src="/Scripts/dataTable/PlanRecord.js" defer></script>
    <script src="/Scripts/dataTable/EquipmentInfoModal.js" defer></script>
}


<h2>@ViewBag.Title</h2>

<section>
    <div class="info-area">
        <div class="datatable datatable-small">
            <div class="datatable-body">
                <table class="datatable-table" id="PlanDetail"></table>
            </div>
        </div>
        <div class="datatable datatable-grid datatable-fill">
            <div class="datatable-body overflow-auto">
                <table class="datatable-table" id="PlanRecord">
                </table>
            </div>
        </div>
    </div>
</section>

@*定位資訊POP UP*@
<div class="modal fade datagrid-modal" tabindex="-1" id="Location">
    <div class="modal-dialog modal-screen-md modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body">
                <h3>定位資訊</h3>
                <div id="BIM" style="height: 50vh;">
                    <div class="pin-area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    @Scripts.Render("https://developer.api.autodesk.com/modelderivative/v2/viewers/viewer3D.min.js")
    @Scripts.Render("~/Scripts/Forge/Viewer.Loading.js")
    @Scripts.Render("~/Scripts/Forge/Viewer.Toolkit.js")
    @Scripts.Render("~/Scripts/Forge/ForgePin.js")
    @Scripts.Render("~/Scripts/Forge/UpViewer.js")
    <script>
        const PlanPathSN = location.href.split('/').pop();
        const apiUrl = '@Url.Action("ReadBody", "SamplePath_Management")';
        let bim = null;

        $(async function () {
            console.log(PlanPathSN)
            readData(apiUrl, PlanPathSN);
            bim = new UpViewer(document.getElementById("BIM"));
        })
        //每日巡檢時程模板 詳情
        const SerializedName = [
            { text: "巡檢路線名稱", value: "PathName" },
            { text: "巡檢頻率", value: "Frequency" },
        ]
        const GridOptions = {
            thead: true,
            columns: [
                { id: "Index", title: "" },
                { id: "InternalCode", title: "RFID內碼" },
                { id: "ExternalCode", title: "RFID外碼" },
                { id: "RFIDName", title: "RFID名稱" },
                { id: "RFIDArea", title: "RFID棟別" },
                { id: "RFIDFloor", title: "RFID樓層" },
                { id: "RFIDMemo", title: "RFID備註" },
                { id: "EName", title: "設備名稱" },
                { id: "NO", title: "設備編號" },
                { id: "Brand", title: "廠牌" },
                { id: "Model", title: "型號" },
                { id: "Frequency", title: "巡檢頻率" },
                {
                    id: "Btn", title: "", formatter: (v, row, i) => {
                        return `<button type="button" class="btn btn-location" data-bs-toggle="modal" data-bs-target="#Location" data-row-index="${i}"><i class="fa-solid fa-location-dot"></i></button>`
                    }
                },
            ]
        }
        let fakeData = {
            PName: "前處理機房巡檢",
            PFrequency: "每3小時",
            Equipments: [
                {
                    InternalCode: "XSCXCZS",
                    ExternalCode: "XSCXCZS",
                    RFIDName: "前處理機房巡檢",
                    RFIDArea: "前處理區",
                    RFIDFloor: "1F",
                    RFIDMemo: "備註備註備註",
                    EName: "螺旋發送機",
                    NO: "SP-0202A",
                    Brand: "XX廠牌",
                    Model: "W004N",
                    Frequency: "每2小時",
                },
                {
                    InternalCode: "XSCXCZS",
                    ExternalCode: "XSCXCZS",
                    RFIDName: "前處理機房巡檢",
                    RFIDArea: "前處理區",
                    RFIDFloor: "1F",
                    RFIDMemo: "備註備註備註",
                    EName: "螺旋發送機",
                    NO: "SP-0202A",
                    Brand: "XX廠牌",
                    Model: "W004N",
                    Frequency: "每2小時",
                },
                {
                    InternalCode: "XSCXCZS",
                    ExternalCode: "XSCXCZS",
                    RFIDName: "前處理機房巡檢",
                    RFIDArea: "前處理區",
                    RFIDFloor: "1F",
                    RFIDMemo: "備註備註備註",
                    EName: "螺旋發送機",
                    NO: "SP-0202A",
                    Brand: "XX廠牌",
                    Model: "W004N",
                    Frequency: "每2小時",
                },
            ]
        }

        function readData(url = null, SN) {

            url == null ? onSuccess(fakeData) :
                $.ajax({
                    url: `${url}?id=${SN}`,
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json;charset=utf-8",
                    success: onSuccess,
                    error: onError
                })

            function onSuccess(res) {
                console.log("res", res);
                if (res.Datas) res = res.Datas
                res.Frequency = `每${res.Frequency}小時`
                $("#PlanDetail").append(createTableInner(res, SerializedName));
                res.Equipments ?
                    $("#PlanRecord").append(createTableGrid(
                        createIndexToArrayData(res.Equipments), GridOptions)) :
                    $("#PlanRecord").parents(".datatable").remove();

                setupBIMModal(res.Equipments);
            }

            function onError(res) {
                console.log(res);
            }
            //在每列加上次序
            function createIndexToArrayData(arr) {
                return arr.map((e, i) => {
                    return {
                        Index: i + 1,
                        ...e,
                    }
                })
            }

            function setupBIMModal(data) {
                const modal = document.getElementById('Location')
                modal.addEventListener('shown.bs.modal', async function (event) {
                    const button = event.relatedTarget
                    const index = button.getAttribute('data-row-index')
                    const row = data[index];
                    if (bim.equipmentPoint) {
                        bim.equipmentPoint.hide();
                    }
                    await bim.init()
                    await bim.loadModels(bim.getModelsUrl(row.RFIDViewName))
                    const position = new THREE.Vector3(row.Location_X, row.Location_Y, 0)
                    if (bim.equipmentPoint) {
                        bim.equipmentPoint.position = position;
                    }
                    else {
                        bim.createEquipmentPoint(position)
                    }
                    bim.equipmentPoint.show().update();
                })
            }
        }
    </script>
}