@{
    ViewBag.Title = "巡檢路線模板詳情";
}
<link rel="stylesheet" href="/Content/samplepath.css">

<h2>@ViewBag.Title</h2>

<div class="datatable datatable-small mt-5">
    <div class="datatable-body">
        <table class="datatable-table" id="PathSampleInfo"></table>
    </div>
</div>

<div class="sample-path-area">
    <h3 class="sample-path-title">巡檢路線規劃</h3>

    <div class="edit-area">
        <div class="sample-path-group-area">
            <div class="input-group sample-path-group">
                <span class="input-group-text" id="sample-path-name"></span>
                <div type="text" class="form-control">
                    <nav>
                        <ol class="breadcrumb" id="path-display">
                            <li class="breadcrumb-item">起點</li>
                            <li class="breadcrumb-item">終點</li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
        <div class="sample-path-draw-area">
            <div class="viewer3Dcontainer">
                <div id="viewer3d" style="margin:0;"></div>
                <canvas id="PathCanvas"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- CDN -->
<link rel="stylesheet" href="https://developer.api.autodesk.com/modelderivative/v2/viewers/style.min.css?v=v7.4"
    type="text/css">
<script language="JavaScript"
    src="https://developer.api.autodesk.com/modelderivative/v2/viewers/viewer3D.min.js?v=v7.4"></script>

<!-- Autodesk Forge -->
<script>
    var viewer;
    var viewerUrl = "../../BimModels/Site01/Resource/3D View/林口(一)/林口(一).svf"; //svf檔路徑
    var myProfileSettings_up = {
        name: "mySettings_up",
        description: "My personal settings.",
        settings: {
            viewType: 1, //orthographic
        },
        persistent: [],
        extensions: {
            load: [],
            unload: [
                //減少toolbar物件
                "Autodesk.Section",
                "Autodesk.Measure",
                "Autodesk.Explode",
                "Autodesk.BimWalk",
                "Autodesk.Viewing.FusionOrbit"
            ]
        }
    }
    async function initializeViewer(callback) {
        Autodesk.Viewing.Private.InitParametersSetting.alpha = true; //設定透明背景可用
        var myViewerDiv = document.getElementById('viewer3d');
        viewer = new Autodesk.Viewing.GuiViewer3D(myViewerDiv, { profileSettings: myProfileSettings_up });
        var options = {
            'env': "Local",
            'document': viewerUrl //svf檔路徑
        };
        Autodesk.Viewing.Initializer(options, function () {
            viewer.start(options.document, options, onSuccessCallback, onErrorCallback);
            async function onSuccessCallback() {
                console.log("onSuccessCallback");
                viewer.setBackgroundOpacity(0);
                viewer.setBackgroundColor();
                viewer.setLightPreset(16);

                viewer.toolbar.removeControl("navTools");
                viewer.toolbar.removeControl("settingsTools");

                viewer.addEventListener(Autodesk.Viewing.GEOMETRY_LOADED_EVENT, function (e) {
                    console.log("GEOMETRY_LOADED_EVENT");
                    viewer.addEventListener(
                        Autodesk.Viewing.FINAL_FRAME_RENDERED_CHANGED_EVENT,
                        loadWireFrame);

                    function loadWireFrame() {
                        console.log("FINAL_FRAME_RENDERED_CHANGED_EVENT");
                        if (!viewer.isExtensionLoaded('Autodesk.Viewing.Wireframes')) {
                            viewer.loadExtension('Autodesk.Viewing.Wireframes').then(callback);
                            viewer.removeEventListener(
                                Autodesk.Viewing.FINAL_FRAME_RENDERED_CHANGED_EVENT,
                                loadWireFrame);
                        }
                    }
                });
                viewer.addEventListener(Autodesk.Viewing.EXTENSION_LOADED_EVENT, function (e) {
                    console.log("EXTENSION_LOADED_EVENT = " + e.extensionId);
                    switch (e.extensionId) {
                        case "Autodesk.ViewCubeUi":
                            const ViewCubeExt = viewer.getExtension("Autodesk.ViewCubeUi");
                            ViewCubeExt.setVisible(false);

                            //上視圖視角設定
                            let pos = new THREE.Vector3(0, 0, 160);
                            let target = new THREE.Vector3(0, 0, 0);
                            viewer.navigation.setView(pos, target);
                            viewer.navigation.setCameraUpVector(new THREE.Vector3(-1, 0, 0));
                            break;
                        case 'Autodesk.Viewing.Wireframes':
                            const wfExt = viewer.getExtension('Autodesk.Viewing.Wireframes');
                            wfExt.activate(); //開啟
                            wfExt.showSolidMaterial(false); //取消固體材質
                            let lineMaterial = new THREE.LineBasicMaterial({
                                color: 0x000000,
                                linewidth: 0.2
                            });
                            wfExt.setLinesMaterial(lineMaterial);
                            wfExt.setLightPreset(16); //開啟邊線時燈光會自動換到大頭貼燈光，所以要設定回自訂燈光
                            console.log("wfExt run end");
                            break;
                    }
                })
            }
            function onErrorCallback() { console.log("onErrorCallback"); }
        });
    }

</script>

<!-- PIXI Draw -->
<script src="https://pixijs.download/release/pixi.js"></script>
<script src="/Scripts/ForgeDraw.js"></script>
<script src="/Scripts/datatable.js"></script>
<script>
    var view = document.querySelector("#PathCanvas");
    var app;
    var stage;

    const deviceDbId = [
        {
            dbId: 3078,
            deviceType: "bluetooth",
            deviceName: "BT-11014",
        },
        {
            dbId: 3239,
            deviceType: "bluetooth",
            deviceName: "BT-11015",
        },
        {
            dbId: 3162,
            deviceType: "bluetooth",
            deviceName: "BT-11016",
        }
    ];

    let btUrl = "/Content/img/bluetooth.svg";

    function initializeDrawer() {
        ForgeDraw.setDrawSetting("point.contextMenu.button", [{
            name: "詳細",
            onClick: function (event, point) {
                console.log(`point ${point.index} => 詳細`, point);
                let index = point.index;
                let pointData = ForgeDraw.lineData[index].forgePos;
                createDataDetailModal({
                    title: "座標資訊",
                    id: "",
                    sn: [
                        { text: "座標X", value: "x" },
                        { text: "座標Y", value: "y" },
                    ],
                    data: { x: pointData ? pointData.x : undefined, y: pointData ? pointData.y : undefined }
                });
            }
        }]);
        ForgeDraw.setDrawSetting("devicePoint.contextMenu.button", [{
            name: "詳細",
            onClick: function (event, point) {
                console.log(`point ${point.index} => 詳細`, point);
                let index = point.index;
                createDataDetailModal({
                    title: "設備資訊",
                    id: "",
                    sn: [
                        { text: "名稱", value: "name" },
                        { text: "DBID", value: "dbid" },
                        { text: "座標X", value: "x" },
                        { text: "座標Y", value: "y" },
                    ],
                    data: {
                        name: point.name,
                        dbid: point.dbId,
                        x: point.forgePos.x,
                        y: point.forgePos.y
                    }
                });
            }
        }]);

        app = ForgeDraw.init(view, viewer, function () {
            ForgeDraw.setControl(ForgeDraw.Control.READONLY);

            deviceDbId.forEach((e) => {
                let btSprite = PIXI.Sprite.from(btUrl);
                btSprite.scale.set(0.6);
                btSprite.anchor.set(0.5);
                let dp = new ForgeDraw.DevicePoint(e, { sprite: btSprite });
            });

            //讀取路線資料
            let reslineData = fakeData.PathSampleRecord.map((d) => {
                let forgePos = new THREE.Vector3(d.LocationX, d.LocationY, 0);
                let pos = viewer.worldToClient(forgePos);
                let position = new PIXI.Point(pos.x, pos.y);
                return {
                    position: position,
                    forgePos: forgePos
                };
            });
            console.log(reslineData);
            ForgeDraw.readLineData(reslineData);

            //讀取路徑
            let route = [...fakeData.PathSampleOrder];
            route.unshift("起點");
            route.push("終點");
            updatePathDisplay(route);
        });

        window.onresize = function () {
            ForgeDraw.resize();
        }

        function calcRoute() {

            if (ForgeDraw.lineData.length > 1) {
                ForgeDraw.devices.forEach((dp) => {
                    dp.update();
                })
            }

            if (!sortRouteModal.autoCalcRoute) {
                return;
            }

            //開始計算路徑
            let route = ForgeDraw.getRoute().map(e => e.name);
            console.log(ForgeDraw.devices.map(e => e.result));

            route.unshift("起點");
            route.push("終點");

            //顯示在網頁上
            updatePathDisplay(route);
        }
    }

    //更新網頁顯示的路徑
    function updatePathDisplay(path = undefined) {
        let $path = $("#path-display");

        if (!path) {
            $path.empty();
            $path.append(`
            <li class="breadcrumb-item">起點</li>
            <li class="breadcrumb-item">終點</li>
            `);
            return;
        }

        $path.empty();
        path.forEach(r => {
            let pathPoint = `<li class="breadcrumb-item">${r}</li>`;
            $path.append(pathPoint);
        })
    }
</script>

<!-- EVENT -->
<script src="../../Scripts/tool.js"></script>
<script>

    const RSN = '@ViewBag.id';
    //let apiUrl = '@Url.Action("ReadBody", "Report_Management")' + `/${RSN}`;
    let apiUrl = null;

    let fakeData = {
        "PathSample": {
            "PSSN": "000001",
            "Area": "Area1",
            "Floor": "Floor1_1",
            "ASN": "1",
            "FSN": "1_1",
            "PathTitle": "123"
        },
        "PathSampleOrder": [
            "BT-11014",
            "BT-11015",
            "BT-11016"
        ],
        "PathSampleRecord": [
            {
                "LocationX": 3.281535257805018,
                "LocationY": -70.78609689705826
            },
            {
                "LocationX": 17.614257498023093,
                "LocationY": -17.842776490580817
            },
            {
                "LocationX": 7.961607826039497,
                "LocationY": -14.332722098991141
            },
            {
                "LocationX": -0.8135282394001422,
                "LocationY": -32.175498589571944
            },
            {
                "LocationX": -9.881168840354427,
                "LocationY": -28.080435132717326
            },
            {
                "LocationX": -10.758682446898383,
                "LocationY": 2.3400362610597796
            },
            {
                "LocationX": -4.616087201090643,
                "LocationY": 2.6325407936922716
            },
            {
                "LocationX": -4.616087201090643,
                "LocationY": 9.94515410950406
            },
            {
                "LocationX": -21.28884572542593,
                "LocationY": 10.530163174769001
            },
            {
                "LocationX": -20.99634118991129,
                "LocationY": -31.59048952430699
            },
            {
                "LocationX": -31.526504468438844,
                "LocationY": -32.76050765483687
            },
            {
                "LocationX": -33.574036217041424,
                "LocationY": -45.63070709066565
            },
            {
                "LocationX": -22.16635933196992,
                "LocationY": -75.46616941917782
            }
        ]
    }

    $(async function () {
        readData(apiUrl);
    });

    function readData(url = null) {

        url == null ? onSuccess(fakeData) :
            $.ajax({
                url: url,
                type: "GET",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

        async function onSuccess(res) {
            console.log(res);
            fakeData = res;
            let ps = res.PathSample;

            $("#PathSampleInfo").append(
                createTableInner(ps, [
                    { text: "巡檢路線模板", value: "PathTitle" },
                    { text: "棟別", value: "Area" },
                    { text: "樓層", value: "Floor" },
                ])
            )

            $("#PathTitle").val(ps.PathTitle);

            $("#sample-path-name").text(ps.PathTitle);

            initializeViewer(initializeDrawer);
        }
        function onError(res) {
            console.log(res);
        }
    }
</script>