
@{
    ViewBag.Title = "警戒值設定";
}

<h2>@ViewBag.Title</h2>

<div class="datatable datatable-small mt-5">
    <div class="datatable-body">
        <table class="datatable-table" id="StockItemInfo"></table>
    </div>
</div>

<div class="edit-area edit-area-small">
    <p style="color: white;font-size: 20px;">警戒值設定</p>
    <form class="form" id="form">
        <div class="form-group d-lg-contents required">
            <label for="ExpiryDate">有效期限</label>
            <input class="form-control" type="date" name="ExpiryDate" id="ExpiryDate" required>
        </div>
        <div class="form-group d-lg-contents required">
            <label for="StockAmount">數量</label>
            <input class="form-control" type="number" name="StockAmount" id="StockAmount" max="365" min="1" value="" required>
        </div>
    </form>
</div>

<div class="edit-button-area">
    <button class="btn btn-back" id="back">返回</button>
    <button class="btn btn-submit" id="submit" form="form">儲存</button>
</div>

<script src="/Scripts/datatable.js"></script>
<script>
    @*var eqList = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(@Model.JsonStr));
    eqList = eqList.replace("\r", "").replace("\n", "");
    var equipmentList = JSON.parse(eqList);
    console.log(equipmentList);*@

    const apiUrl = null;

    const SerializedName = [
        { text: "庫存編號", value: "SISN" },
        { text: "品項", value: "StockType" },
        { text: "品名", value: "StockName" },
        { text: "單位", value: "Unit" },
    ]

    const GridOptions = {
        thead: true,
        columns: [
            { id: "SISN", title: "庫存編號" },
            { id: "StockType", title: "品項"},
            { id: "StockName", title: "品名" },
            { id: "Unit", title: "單位"},
        ]
    }

    const fakeData = {
        SISN: "1120301001",
        StockType: "備料",
        StockName: "藥劑-1",
        Unit: "罐",
    }

    function readData(url = null) {

        url == null ? onSuccess(fakeData) :   //fakeData
            $.ajax({
                url: url,
                data: JSON.stringify(jsonData),
                type: "POST",
                dataType: "json",
                contentType: "application/json;charset=utf-8",
                success: onSuccess,
                error: onError
            })

        function onSuccess(res) {
            console.log(res);
            $("#StockItemInfo").append(createTableInner(res, SerializedName));
            if (res.StockItem) {
                $("#StockItem").append(createTableGrid(res.StockItem, GridOptions))
            }
            else {
                $("#StockItem").parents(".datatable").remove();
            }
        }
        function onError(res) {
            console.log(res);
        }
    }


    function addButtonEvent() {
        $("#back").click(function () {
            history.back();
        });

        $("#submit").click(save);
    }

    function save(e) {
    let isValidity = $("form").toArray().map(e => e.reportValidity()).every(e => e);
    console.log("isValidity:", isValidity);

    let jsonData = {
        EMISN: $("#EMISN").val(),
        Unit: $("#Unit").val(),
        Period: $("#Period").val(),
        IsEnable: $("#IsEnable").val(),
    }

    console.log("jsonData:", jsonData);
    console.log("A", JSON.stringify(jsonData))
    if (!isValidity) { return }
    e.preventDefault();
    $.ajax({
        url: '@Url.Action("EditBodySave", "EquipmentMaintainPeriod_Management")',
        data: JSON.stringify(jsonData),
        type: "post",
        dataType: "json",
        contentType: "application/json; charset=utf-8",
        success: onSuccess,
        error: onError
    })
    function onSuccess(res) {
        console.log(res);
        window.open('@Url.Action("Management", "EquipmentMaintainPeriod_Management")',"_self")
    }
    function onError(res) {
        console.log(res);
    }
}

    window.onload = function () {
        readData(apiUrl);
        addButtonEvent();
    }
</script>

